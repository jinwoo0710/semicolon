<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>KOKO - Korean Product Guide</title>
    <link rel="stylesheet" as="style" crossorigin
        href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        :root { --primary-black: #111111; --primary-white: #ffffff; --accent-gray: #777777; --light-gray: #f2f2f2; --border-color: #dddddd; --hover-color: #e8e8e8; --focus-ring: rgba(17, 17, 17, 0.15); }
        body { font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--primary-white); color: var(--primary-black); line-height: 1.5; overflow-x: hidden; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        .splash-screen { position: fixed; inset: 0; background: var(--primary-black); z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s ease-out; gap: 1.5rem; color: var(--primary-white); }
        .splash-screen.fade-out { opacity: 0; pointer-events: none; }
        .splash-title { font-size: 3.5rem; font-weight: 800; letter-spacing: -0.05em; opacity: 0; animation: splashFadeIn 0.8s ease-out 0.3s forwards; }
        @keyframes splashFadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .home-screen { min-height: 100vh; padding: 2.5rem 1.5rem; display: flex; flex-direction: column; align-items: center; }
        .header { width: 100%; max-width: 500px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 4rem; }
        .logo-text { font-size: 1.8rem; font-weight: 800; letter-spacing: -0.03em; }
        .lang-btn { padding: 0.6rem 1rem; background: var(--light-gray); border: 1px solid var(--border-color); border-radius: 0; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease; box-shadow: none; display: flex; align-items: center; gap: 0.4rem; }
        .main-content { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; gap: 3rem; width: 100%; max-width: 500px; }
        .welcome-text h1 { font-size: clamp(2.2rem, 8vw, 3.2rem); font-weight: 800; line-height: 1.2; letter-spacing: -0.04em; margin-bottom: 0.8rem; }
        .welcome-text p { font-size: 1.15rem; color: var(--accent-gray); font-weight: 500; }
        .search-options { width: 100%; display: flex; flex-direction: column; gap: 1rem; }
        .search-option { background: var(--primary-white); border: 2px solid var(--primary-black); border-radius: 0; padding: 1.5rem; display: flex; align-items: center; gap: 1rem; cursor: pointer; transition: all 0.2s ease-out; box-shadow: 4px 4px 0px var(--primary-black); }
        .search-option:hover { transform: translate(-2px, -2px); box-shadow: 6px 6px 0px var(--primary-black); background-color: var(--light-gray); }
        .option-icon { width: 3.5rem; height: 3.5rem; color: var(--primary-black); background: var(--light-gray); border-radius: 0; display: flex; align-items: center; justify-content: center; flex-shrink: 0; border: 1px solid var(--border-color); padding: 0.5rem; }
        .option-icon svg { width: 100%; height: 100%; object-fit: contain; }
        .option-info { flex: 1; text-align: left; }
        .option-title { font-size: 1.1rem; font-weight: 700; margin-bottom: 0.25rem; letter-spacing: -0.01em; }
        .option-desc { font-size: 0.9rem; color: var(--accent-gray); line-height: 1.4; font-weight: 400; }
        .page-slide-right { position: fixed; inset: 0; background: var(--primary-white); z-index: 1000; transition: transform 0.3s cubic-bezier(0.7, 0, 0.3, 1); box-shadow: none; overflow-y: auto; transform: translateX(100%); }
        .page-slide-right.active { transform: translateX(0); }
        .page-header { background: var(--primary-white); padding: 1rem 1.5rem; display: flex; align-items: center; gap: 0.8rem; border-bottom: 2px solid var(--primary-black); z-index: 100; position: sticky; top: 0; }
        .back-btn { width: 44px; height: 44px; border-radius: 0; background: var(--primary-black); color: var(--primary-white); border: none; font-size: 1.5rem; font-weight: 800; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease-out; box-shadow: none; }
        .header-logo { flex: 1; font-size: 1.5rem; font-weight: 800; letter-spacing: -0.03em; text-align: center; margin-right: 44px; cursor: pointer; transition: opacity 0.2s; }
        .header-logo:hover { opacity: 0.7; }
        .search-input { flex: 1; padding: 0.8rem 1.2rem; border: 2px solid var(--primary-black); border-radius: 0; background: var(--light-gray); font-size: 1rem; outline: none; transition: all 0.2s ease-out; box-shadow: inset 2px 2px 0px rgba(0, 0, 0, 0.1); }
        .results-container { padding: 0.5rem 1.5rem; }
        .result-card { background: transparent; border-bottom: 1px solid var(--border-color); padding: 1rem 0.5rem; cursor: pointer; transition: background-color 0.15s ease-out; }
        .result-card:hover { background-color: var(--light-gray); }
        .result-name { font-size: 1.05rem; font-weight: 600; margin-bottom: 0.2rem; }
        .result-desc { font-size: 0.85rem; color: var(--accent-gray); font-weight: 400; }
        .detail-hero { padding: 2rem 1.5rem; background: var(--primary-white); border-bottom: 2px solid var(--primary-black); }
        .detail-title { font-size: 2.2rem; font-weight: 800; letter-spacing: -0.03em; margin-bottom: 0.5rem; }
        .detail-subtitle { font-size: 1rem; color: var(--accent-gray); margin-bottom: 1.5rem; font-weight: 500; }
        .info-grid { display: flex; flex-direction: column; gap: 0; margin: 1.5rem 0; border-top: 1px solid var(--border-color); }
        .info-item { background: transparent; padding: 0.9rem 0.25rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .info-label { font-size: 0.9rem; color: var(--accent-gray); font-weight: 500; }
        .info-value { font-size: 0.95rem; font-weight: 600; text-align: right; color: var(--primary-black); word-break: break-all; }
        .scanner-modal { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.85); z-index: 3000; display: none; align-items: center; justify-content: center; padding: 1rem; }
        .scanner-modal.active { display: flex; }
        .barcode-modal-content { background: var(--primary-white); border-radius: 0; width: 100%; max-width: 500px; margin: 0 auto; overflow: hidden; display: flex; flex-direction: column; border: 2px solid var(--primary-black); box-shadow: 6px 6px 0px rgba(0, 0, 0, 0.2); }
        .barcode-header { background: var(--primary-black); padding: 1rem 1.5rem; display: flex; align-items: center; justify-content: space-between; color: var(--primary-white); }
        .close-scan-btn { width: 36px; height: 36px; border-radius: 0; background: rgba(255, 255, 255, 0.2); border: none; color: var(--primary-white); font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .scan-title { font-size: 1.1rem; font-weight: 700; flex: 1; text-align: center; margin-right: 2.25rem; }
        .scanner-container { position: relative; background: #000; height: 280px; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        #scanner-viewport, #scanner-viewport video, #scanner-viewport canvas { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; }
        .scan-overlay { position: absolute; inset: 0; pointer-events: none; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .scan-guide { width: 70%; max-width: 300px; height: 120px; position: relative; border: 2px solid #00FF00; }
        .scan-line { position: absolute; top: 0; left: 0; right: 0; height: 2px; background: #00FF00; animation: scan 2s cubic-bezier(0.5, 0, 0.5, 1) infinite; box-shadow: 0 0 8px #00FF00; }
        @keyframes scan { 0% { transform: translateY(0); } 100% { transform: translateY(118px); } }
        .manual-input { padding: 1.5rem; background: var(--light-gray); border-top: 1px solid var(--border-color); }
        .barcode-input { width: 100%; padding: 0.8rem 1rem; border: 2px solid var(--primary-black); border-radius: 0; font-size: 1rem; text-align: center; margin-bottom: 0.8rem; outline: none; background-color: var(--primary-white); transition: all 0.2s ease-out; box-shadow: inset 2px 2px 0px rgba(0, 0, 0, 0.1); }
        .search-barcode-btn { width: 100%; padding: 0.9rem; background: var(--primary-black); color: var(--primary-white); border: 2px solid var(--primary-black); border-radius: 0; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease-out; box-shadow: 3px 3px 0px rgba(0, 0, 0, 0.2); }
        .loading { text-align: center; padding: 3rem; color: var(--accent-gray); font-weight: 500; font-size: 1rem; }
        .spinner { width: 36px; height: 36px; border: 3px solid var(--border-color); border-top-color: var(--primary-black); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 1rem; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .toast { position: fixed; bottom: 2.5rem; left: 50%; transform: translateX(-50%) translateY(100px); background: var(--primary-black); color: var(--primary-white); padding: 0.8rem 1.2rem; border-radius: 0; font-size: 0.9rem; z-index: 5000; opacity: 0; transition: all 0.3s ease-out; box-shadow: 4px 4px 0px rgba(0, 0, 0, 0.2); }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .no-results { text-align: center; padding: 4rem 1.5rem; color: var(--accent-gray); font-weight: 500; font-size: 1rem; }
        .gemini-result-card { margin: 1rem 0; padding: 1.5rem; background: var(--light-gray); border: 2px solid var(--border-color); border-radius: 0; box-shadow: 4px 4px 0px var(--border-color); }
        .gemini-result-card h3 { font-size: 1.1rem; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 1px solid var(--border-color); }
        .gemini-result-card p { font-size: 0.95rem; line-height: 1.7; font-weight: 500; color: var(--primary-black); }
        @media (max-width: 600px) { input[type="text"], input[type="number"] { font-size: 16px; } }
    </style>
</head>

<body>
    <div class="splash-screen" id="splash"> <div class="splash-title">KOKO</div> </div>
    <main class="home-screen" id="home"> <header class="header"> <div class="logo"> <span class="logo-text">KOKO</span> </div> <button class="lang-btn" onclick="toggleLanguage()"> <span id="langFlag">ğŸ‡°ğŸ‡·</span> <span id="langCode">KO</span> </button> </header> <div class="main-content"> <div class="welcome-text"> <h1 id="appTitle">í•œêµ­ ì œí’ˆì„<br>ì‰½ê²Œ ì°¾ì•„ë³´ì„¸ìš”</h1> <p id="appSubtitle">ê²€ìƒ‰ ë°©ë²•ì„ ì„ íƒí•˜ì„¸ìš”</p> </div> <div class="search-options"> <div class="search-option" onclick="showPage('searchResults')"> <div class="option-icon"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"> <path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" /> </svg> </div> <div class="option-info"> <h3 class="option-title" id="searchByName">ìƒí’ˆëª… ê²€ìƒ‰</h3> <p class="option-desc" id="searchByNameDesc">ì´ë¦„ì´ë‚˜ ë¸Œëœë“œë¡œ ì œí’ˆ ì°¾ê¸°</p> </div> </div> <div class="search-option" onclick="openBarcodeScanner()"> <div class="option-icon"> <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"> <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 4.5A.75.75 0 0 1 4.5 3.75h15a.75.75 0 0 1 .75.75v15a.75.75 0 0 1-.75.75h-15a.75.75 0 0 1-.75-.75v-15ZM8.25 9v6m3-6v6m3-6v6m3-6v6" /> </svg> </div> <div class="option-info"> <h3 class="option-title" id="scanBarcode">ë°”ì½”ë“œ ìŠ¤ìº”</h3> <p class="option-desc" id="scanBarcodeDesc">ë°”ì½”ë“œë¡œ ì •í™•í•˜ê²Œ ì œí’ˆ ì°¾ê¸°</p> </div> </div> </div> </div> </main>
    <div class="page-slide-right" id="searchResults"> <div class="page-header"> <button class="back-btn" onclick="goBack()">â†</button> <input type="text" class="search-input" id="searchInput" placeholder="ìƒí’ˆëª…ì„ ì…ë ¥í•˜ì„¸ìš”..."> </div> <div class="results-container" id="resultsContainer"></div> </div>
    <div class="page-slide-right" id="detail"> <div class="page-header"> <button class="back-btn" onclick="goBack()">â†</button> <div class="header-logo" onclick="goToHome()">KOKO</div> </div> <div id="detailPageContent"></div> </div>
    <div class="scanner-modal" id="scannerModal"> <div class="barcode-modal-content"> <div class="barcode-header"> <h3 class="scan-title" id="barcodeScanTitle">ë°”ì½”ë“œ ìŠ¤ìºë„ˆ</h3> <button class="close-scan-btn" onclick="closeScanner()">Ã—</button> </div> <div class="scanner-container" id="scanner-container"> <div id="scanner-viewport"></div> <div class="scan-overlay"> <div class="scan-guide"> <div class="scan-line"></div> </div> </div> </div> <div class="manual-input"> <input type="number" class="barcode-input" id="manualBarcode" placeholder="ë°”ì½”ë“œ ë²ˆí˜¸ ì§ì ‘ ì…ë ¥"> <button class="search-barcode-btn" id="searchBarcodeBtn" onclick="searchByManualBarcode()">ê²€ìƒ‰</button> </div> </div> </div>
    <div class="toast" id="toast"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <script>
        // --- API & ì„¤ì • ---
        const FOOD_API_KEY = 'c320de96f22d4183bd13';
        const TRANSLATE_API_KEY = 'AIzaSyArr1P7f6JuAL8Xz8ECiHi8WkfbNRn4Z7I'; // ğŸš¨ Google ë²ˆì—­ API í‚¤ ì…ë ¥
        const GEMINI_API_KEY = 'AIzaSyDrsbT0bzRyi1WOA3byzJI8VOIY2NpYa6Y'; // ğŸš¨ Gemini API í‚¤ ì…ë ¥
        const PROXY_URL = 'https://corsproxy.io/?';
        const FOOD_API_BASE = `https://openapi.foodsafetykorea.go.kr/api/${FOOD_API_KEY}/C005/json`;

        // --- ì „ì—­ ë³€ìˆ˜ ---
        let currentLang = 'ko';
        let searchCache = null;
        let pageHistory = ['home'];
        let isTranslatingCache = false;

        // --- ë‹¤êµ­ì–´ í…ìŠ¤íŠ¸ ---
        const translations = {
            ko: { appTitle: 'í•œêµ­ ì œí’ˆì„<br>ì‰½ê²Œ ì°¾ì•„ë³´ì„¸ìš”', appSubtitle: 'ê²€ìƒ‰ ë°©ë²•ì„ ì„ íƒí•˜ì„¸ìš”', searchByName: 'ìƒí’ˆëª… ê²€ìƒ‰', searchByNameDesc: 'ì´ë¦„ì´ë‚˜ ë¸Œëœë“œë¡œ ì œí’ˆ ì°¾ê¸°', scanBarcode: 'ë°”ì½”ë“œ ìŠ¤ìº”', scanBarcodeDesc: 'ë°”ì½”ë“œë¡œ ì •í™•í•˜ê²Œ ì œí’ˆ ì°¾ê¸°', searchPlaceholder: 'ìƒí’ˆëª…ì„ ì…ë ¥í•˜ì„¸ìš”...', productDetail: 'ìƒí’ˆ ìƒì„¸ ì •ë³´', manufacturer: 'ì œì¡°ì‚¬', expiry: 'ì†Œë¹„ê¸°í•œ', barcode: 'ë°”ì½”ë“œ', reportNumber: 'í’ˆëª©ë³´ê³ ë²ˆí˜¸', searching: 'ê²€ìƒ‰ ì¤‘...', noResults: 'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤', loadingInfo: 'ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...', errorLoading: 'ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ', barcodeTitle: 'ë°”ì½”ë“œ ìŠ¤ìºë„ˆ', search: 'ê²€ìƒ‰', product_found: 'ìƒí’ˆì„ ì°¾ì•˜ìŠµë‹ˆë‹¤!', product_not_found: 'ìƒí’ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', camera_error: 'ì¹´ë©”ë¼ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', invalid_barcode: 'ìœ íš¨í•œ ë°”ì½”ë“œ ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', translation_needed: 'ë²ˆì—­ì„ ìœ„í•´ API í‚¤ê°€ í•„ìš”í•©ë‹ˆë‹¤.', preparing_dictionary: 'ì‚¬ì „ ë°ì´í„° ì¤€ë¹„ ì¤‘...', gemini_searching: 'ì¸í„°ë„· í¬ë¡¤ë§ ì¤‘...' },
            en: { appTitle: 'Find Korean<br>Products Easily', appSubtitle: 'Choose your search method', searchByName: 'Search by Name', searchByNameDesc: 'Find products using their name', scanBarcode: 'Scan Barcode', scanBarcodeDesc: 'Find products with their barcode', searchPlaceholder: 'Enter product name...', productDetail: 'Product Details', manufacturer: 'Manufacturer', expiry: 'Shelf Life', barcode: 'Barcode', reportNumber: 'Report No.', searching: 'Searching...', noResults: 'No search results found', loadingInfo: 'Loading information...', errorLoading: 'Error loading details', barcodeTitle: 'Barcode Scanner', search: 'Search', product_found: 'Product Found!', product_not_found: 'Product not found.', camera_error: 'Could not access camera.', invalid_barcode: 'Please enter a valid barcode.', translation_needed: 'API key is required for translation.', preparing_dictionary: 'Preparing dictionary...', gemini_searching: 'ğŸ¤– Asking Gemini AI...' },
            ja: { appTitle: 'éŸ“å›½è£½å“ã‚’<br>ç°¡å˜ã«è¦‹ã¤ã‘ã‚ˆã†', appSubtitle: 'æ¤œç´¢æ–¹æ³•ã‚’é¸ã‚“ã§ãã ã•ã„', searchByName: 'å•†å“åã§æ¤œç´¢', searchByNameDesc: 'å•†å“åã§è£½å“ã‚’æ¤œç´¢', scanBarcode: 'ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³', scanBarcodeDesc: 'ãƒãƒ¼ì½”ë“œã§è£½å“ã‚’æ¤œç´¢', searchPlaceholder: 'å•†å“åã‚’å…¥åŠ›...', productDetail: 'å•†å“è©³ç´°', manufacturer: 'è£½é€ ç¤¾', expiry: 'æ¶ˆè²»æœŸé™', barcode: 'ãƒãƒ¼ì½”ë“œ', reportNumber: 'å“ç›®å ±å‘Šç•ªå·', searching: 'æ¤œç´¢ä¸­...', noResults: 'æ¤œç´¢çµæœãŒã‚ã‚Šã¾ã›ã‚“', loadingInfo: 'æƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­...', errorLoading: 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', barcodeTitle: 'ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒŠãƒ¼', search: 'æ¤œç´¢', product_found: 'è£½å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸï¼', product_not_found: 'è£½å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', camera_error: 'ã‚«ãƒ¡ãƒ©ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“', invalid_barcode: 'æœ‰åŠ¹ãªãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', translation_needed: 'ç¿»è¨³ã«ã¯APIã‚­ãƒ¼ãŒå¿…è¦ã§ã™', preparing_dictionary: 'è¾æ›¸ã‚’æº–å‚™ã—ã¦ã„ã¾ã™...', gemini_searching: 'ğŸ¤– Gemini AIã«å•ã„åˆã‚ã›ä¸­...' }
        };
        const getText = (key) => translations[currentLang][key] || key;

        // --- ì´ˆê¸°í™” ë° UI ì´ë²¤íŠ¸ ---
        document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => { document.getElementById('splash').classList.add('fade-out'); }, 1500);
            fetchAllProducts();
            let searchTimeout;
            document.getElementById('searchInput').addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                const query = e.target.value.trim();
                if (isTranslatingCache) return;
                if (query.length === 0) {
                    document.getElementById('resultsContainer').innerHTML = '';
                    return;
                }
                searchTimeout = setTimeout(() => searchProducts(query), 200);
            });
            updateUITexts();
        });

        // --- í˜ì´ì§€ ê´€ë¦¬ ---
        function showPage(pageId) {
            const newPage = document.getElementById(pageId);
            if (newPage && pageHistory[pageHistory.length - 1] !== pageId) {
                newPage.classList.add('active');
                pageHistory.push(pageId);
            }
            if (pageId === 'searchResults') {
                if (isTranslatingCache) {
                    document.getElementById('resultsContainer').innerHTML = `<div class="loading"><div class="spinner"></div>${getText('preparing_dictionary')}</div>`;
                }
                document.getElementById('searchInput').focus();
            }
        }

        function goBack() {
            if (pageHistory.length <= 1) return;
            const currentPageId = pageHistory.pop();
            const currentPage = document.getElementById(currentPageId);
            if (currentPage) { currentPage.classList.remove('active'); }
            if (currentPageId === 'searchResults') {
                document.getElementById('searchInput').value = '';
                document.getElementById('resultsContainer').innerHTML = '';
            }
        }

        function goToHome() {
            document.querySelectorAll('.page-slide-right.active').forEach(page => page.classList.remove('active'));
            pageHistory = ['home'];
            document.getElementById('searchInput').value = '';
            document.getElementById('resultsContainer').innerHTML = '';
        }

        // --- UI ì—…ë°ì´íŠ¸ ---
        function updateUITexts() {
            document.getElementById('appTitle').innerHTML = getText('appTitle');
            document.getElementById('appSubtitle').textContent = getText('appSubtitle');
            document.getElementById('searchByName').textContent = getText('searchByName');
            document.getElementById('searchByNameDesc').textContent = getText('searchByNameDesc');
            document.getElementById('scanBarcode').textContent = getText('scanBarcode');
            document.getElementById('scanBarcodeDesc').textContent = getText('scanBarcodeDesc');
            document.getElementById('searchInput').placeholder = getText('searchPlaceholder');
            document.getElementById('barcodeScanTitle').textContent = getText('barcodeTitle');
            document.getElementById('searchBarcodeBtn').textContent = getText('search');
        }

        async function toggleLanguage() {
            const langs = ['ko', 'en', 'ja'];
            const flags = { ko: 'ğŸ‡°ğŸ‡·', en: 'ğŸ‡ºğŸ‡¸', ja: 'ğŸ‡¯ğŸ‡µ' };
            const codes = { ko: 'KO', en: 'EN', ja: 'JP' };
            currentLang = langs[(langs.indexOf(currentLang) + 1) % langs.length];
            document.getElementById('langFlag').textContent = flags[currentLang];
            document.getElementById('langCode').textContent = codes[currentLang];
            updateUITexts();
            await translateProductCache(currentLang);
        }

        // --- ë°ì´í„° ì²˜ë¦¬ ë° API í˜¸ì¶œ ---
        async function fetchAllProducts() {
            if (searchCache) return;
            const url = `${FOOD_API_BASE}/1/1000`;
            try {
                const response = await fetch(PROXY_URL + url);
                if (!response.ok) throw new Error(`API ì‘ë‹µ ì‹¤íŒ¨: Status ${response.status}`);
                const data = await response.json();
                const apiResult = data.C005?.RESULT || data.RESULT;
                if (apiResult && apiResult.CODE !== 'INFO-000') throw new Error(`API ì˜¤ë¥˜: ${apiResult.MSG}`);
                searchCache = data.C005?.row || [];
            } catch (error) {
                console.error("ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:", error);
                showToast(error.message);
                searchCache = [];
            }
        }

        async function translateProductCache(targetLang) {
            if (targetLang === 'ko' || !searchCache || isTranslatingCache) return;
            const firstProduct = searchCache[0];
            if (firstProduct && firstProduct[`PRDLST_NM_${targetLang}`]) return;
            
            isTranslatingCache = true;
            showToast(getText('preparing_dictionary'));
            const activePage = pageHistory[pageHistory.length - 1];
            if (activePage === 'searchResults') {
                document.getElementById('resultsContainer').innerHTML = `<div class="loading"><div class="spinner"></div>${getText('preparing_dictionary')}</div>`;
            }
            try {
                const productNames = [...new Set(searchCache.map(p => p.PRDLST_NM).filter(Boolean))];
                const companyNames = [...new Set(searchCache.map(p => p.BSSH_NM).filter(Boolean))];
                const CHUNK_SIZE = 100;
                async function processInChunks(names) {
                    const allTranslated = [];
                    for (let i = 0; i < names.length; i += CHUNK_SIZE) {
                        const chunk = names.slice(i, i + CHUNK_SIZE);
                        const translatedChunk = await translate(chunk, 'ko', targetLang, true);
                        allTranslated.push(...translatedChunk);
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                    return allTranslated;
                }
                const [translatedProductNames, translatedCompanyNames] = await Promise.all([
                    processInChunks(productNames),
                    processInChunks(companyNames)
                ]);
                const productNameMap = new Map(productNames.map((name, i) => [name, translatedProductNames[i]]));
                const companyNameMap = new Map(companyNames.map((name, i) => [name, translatedCompanyNames[i]]));
                searchCache.forEach(product => {
                    if (product.PRDLST_NM) product[`PRDLST_NM_${targetLang}`] = productNameMap.get(product.PRDLST_NM);
                    if (product.BSSH_NM) product[`BSSH_NM_${targetLang}`] = companyNameMap.get(product.BSSH_NM);
                });
            } catch (error) {
                console.error("ë²ˆì—­ ìºì‹œ ìƒì„± ì‹¤íŒ¨:", error);
                showToast("ì‚¬ì „ ë°ì´í„°ë¥¼ ì¤€ë¹„í•˜ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            } finally {
                isTranslatingCache = false;
                if (activePage === 'searchResults') document.getElementById('resultsContainer').innerHTML = '';
            }
        }

        async function searchProducts(query) {
            if (!searchCache) await fetchAllProducts();
            const container = document.getElementById('resultsContainer');
            container.innerHTML = `<div class="loading"><div class="spinner"></div>${getText('searching')}</div>`;
            const lowerCaseQuery = query.toLowerCase();
            const productNameKey = currentLang === 'ko' ? 'PRDLST_NM' : `PRDLST_NM_${currentLang}`;
            const companyNameKey = currentLang === 'ko' ? 'BSSH_NM' : `BSSH_NM_${currentLang}`;

            const results = searchCache.filter(p =>
                (p[productNameKey]?.toLowerCase().includes(lowerCaseQuery)) ||
                (p[companyNameKey]?.toLowerCase().includes(lowerCaseQuery))
            ).slice(0, 30);

            if (results.length === 0) {
                const geminiResult = await searchWithGemini(query);
                if (geminiResult) {
                    const formattedText = geminiResult.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>').replace(/\n/g, '<br>');
                    container.innerHTML = `
                        <div class="gemini-result-card">
                            <h3>ì¸í„°ë„· í¬ë¡¤ë§ ê²€ìƒ‰ ê²°ê³¼: ${query}</h3>
                            <p>${formattedText}</p>
                        </div>
                    `;
                } else {
                    container.innerHTML = `<div class="no-results">${getText('noResults')}</div>`;
                }
            } else {
                container.innerHTML = results.map(product => `
                    <div class="result-card" onclick='showProductDetail(${JSON.stringify(product)})'>
                        <h3 class="result-name">${product[productNameKey] || product.PRDLST_NM}</h3>
                        <p class="result-desc">${product[companyNameKey] || product.BSSH_NM}</p>
                    </div>
                `).join('');
            }
        }

        async function searchWithGemini(query) {
            const container = document.getElementById('resultsContainer');
            container.innerHTML = `<div class="loading"><div class="spinner"></div>${getText('gemini_searching')}</div>`;
            
            // âœ… [ìˆ˜ì •ë¨] Gemini API URLì„ ë²”ìš©ì ì¸ 'gemini-pro' ëª¨ë¸ë¡œ ë³€ê²½
            const GEMINI_URL = `https://generativelanguage.googleapis.com/v1/models/gemini-2.5-pro:generateContent?key=${GEMINI_API_KEY}`;
            const prompt = `'${query}'ì—ëŒ€í•œ ì œì¡°ì‚¬, ì†Œë¹„ê¸°í•œ, ë°”ì½”ë“œë²ˆí˜¸, í’ˆëª©ë³´ê³ ë²ˆí˜¸, ì¹¼ë¡œë¦¬, íƒ„ë‹¨ì§€, ì„±ë¶„, ë¹„ê±´ì—¬ë¶€, ì•Œë ˆë¥´ê¸°ì •ë³´ ë¥¼ í‘œë¡œ ë³´ì—¬ì¤˜`;
            
            try {
                const response = await fetch(GEMINI_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ "contents": [{ "parts": [{ "text": prompt }] }] })
                });
                if (!response.ok) throw new Error(`ì¸í„°ë„· í¬ë¡¤ë§ ì˜¤ë¥˜: Status ${response.status}`);
                const data = await response.json();
                
                if (!data.candidates || data.candidates.length === 0) {
                    throw new Error("ì¸í„°ë„· í¬ë¡¤ë§ìœ¼ë¡œë¶€í„° ìœ íš¨í•œ ë‹µë³€ì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
                }
                return data.candidates[0].content.parts[0].text;
            } catch (error) {
                console.error("ì¸í„°ë„· í¬ë¡¤ë§ ì‹¤íŒ¨:", error);
                showToast("ì¸í„°ë„· í¬ë¡¤ë§ ê²€ìƒ‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                return null;
            }
        }
        
        async function showProductDetail(productData) {
            const product = JSON.parse(JSON.stringify(productData));
            const content = document.getElementById('detailPageContent');
            showPage('detail');
            content.innerHTML = `<div class="loading"><div class="spinner"></div>${getText('loadingInfo')}</div>`;
            const pName = product[`PRDLST_NM_${currentLang}`] || await translate(product.PRDLST_NM || '', 'ko', currentLang);
            const pCompany = product[`BSSH_NM_${currentLang}`] || await translate(product.BSSH_NM || '', 'ko', currentLang);
            content.innerHTML = `
                <div class="detail-hero">
                    <h1 class="detail-title">${pName}</h1>
                    <p class="detail-subtitle">${pCompany || '-'}</p>
                </div>
                <div class="detail-content">
                    <div class="info-grid">
                        <div class="info-item"><p class="info-label">${getText('manufacturer')}</p><p class="info-value">${pCompany || '-'}</p></div>
                        <div class="info-item"><p class="info-label">${getText('expiry')}</p><p class="info-value">${product.POG_DAYCNT || '-'}</p></div>
                        <div class="info-item"><p class="info-label">${getText('barcode')}</p><p class="info-value">${product.BAR_CD || '-'}</p></div>
                        <div class="info-item"><p class="info-label">${getText('reportNumber')}</p><p class="info-value">${product.PRDLST_REPORT_NO || '-'}</p></div>
                    </div>
                </div>`;
        }
        
        async function translate(text, sourceLang, targetLang, isBatch = false) {
            if (!text || text.length === 0) { return isBatch ? [] : ""; }
            if (sourceLang === targetLang || TRANSLATE_API_KEY === 'YOUR_GOOGLE_TRANSLATE_API_KEY') {
                if (TRANSLATE_API_KEY === 'YOUR_GOOGLE_TRANSLATE_API_KEY' && sourceLang !== targetLang) console.warn(getText('translation_needed'));
                return isBatch ? text.map(t => t) : text;
            }
            try {
                const response = await fetch(`https://translation.googleapis.com/language/translate/v2?key=${TRANSLATE_API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ q: text, target: targetLang, source: sourceLang })
                });
                if (!response.ok) {
                    if (response.status === 400) {
                        const errorData = await response.json();
                        console.error("ë²ˆì—­ API 400 ì˜¤ë¥˜ ìƒì„¸:", errorData.error.message);
                        throw new Error(`ë²ˆì—­ API ì˜¤ë¥˜: ì˜ëª»ëœ ìš”ì²­ì…ë‹ˆë‹¤.`);
                    }
                    throw new Error(`ë²ˆì—­ API ì˜¤ë¥˜: ${response.status}`);
                }
                const data = await response.json();
                if (isBatch) return data.data.translations.map(t => t.translatedText);
                return data.data.translations[0].translatedText;
            } catch (error) {
                console.error("Translation Error:", error);
                throw error;
            }
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        // --- ë°”ì½”ë“œ ìŠ¤ìºë„ˆ ---
        let isScanning = false;
        function startScanning() {
            if(isScanning) return;
            Quagga.init({
                inputStream: { name: "Live", type: "LiveStream", target: '#scanner-viewport', constraints: { facingMode: "environment" }},
                decoder: { readers: ["ean_reader"] },
            }, (err) => {
                if (err) { showToast(getText('camera_error')); return; }
                Quagga.start();
                isScanning = true;
            });
            Quagga.onDetected(onBarcodeDetected);
        }

        function stopScanning() {
            if(isScanning) { Quagga.offDetected(onBarcodeDetected); Quagga.stop(); isScanning = false; }
        }

        const onBarcodeDetected = Quagga.debounce((result) => {
            stopScanning();
            findProductByBarcode(result.codeResult.code);
        }, 500, true);
        
        async function findProductByBarcode(barcode) {
            const url = `${FOOD_API_BASE}/1/5/BAR_CD=${barcode}`;
            try {
                const response = await fetch(PROXY_URL + url);
                if (!response.ok) throw new Error(`API ì‘ë‹µ ì‹¤íŒ¨: ${response.status}`);
                const data = await response.json();
                if (data.C005?.row) {
                    const product = Array.isArray(data.C005.row) ? data.C005.row[0] : data.C005.row;
                    showToast(getText('product_found'));
                    closeScanner();
                    showProductDetail(product);
                } else {
                    showToast(getText('product_not_found'));
                    closeScanner();
                }
            } catch (error) {
                showToast(error.message);
                closeScanner();
            }
        }

        function searchByManualBarcode() {
            const barcode = document.getElementById('manualBarcode').value.trim();
            if(barcode.length < 8) { showToast(getText('invalid_barcode')); return; }
            findProductByBarcode(barcode);
        }
    </script>
</body>

</html>
