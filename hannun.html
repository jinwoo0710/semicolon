
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>HANNUN - Korean Product Guide</title>
    <link rel="stylesheet" as="style" crossorigin
        href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard@v1.3.9/dist/web/static/pretendard.min.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        :root { --primary-black: #111111; --primary-white: #ffffff; --accent-gray: #777777; --light-gray: #f2f2f2; --border-color: #dddddd; --hover-color: #e8e8e8; }
        body { font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--primary-white); color: var(--primary-black); line-height: 1.5; overflow-x: hidden; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        .splash-screen { position: fixed; inset: 0; background: var(--primary-black); z-index: 10000; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s ease-out; gap: 1.5rem; color: var(--primary-white); }
        .splash-screen.fade-out { opacity: 0; pointer-events: none; }
        .splash-title { font-size: 3.5rem; font-weight: 800; letter-spacing: -0.05em; display: flex; }
        .splash-logo-container { display: flex; flex-direction: column; align-items: center; }
        .splash-title span, .splash-subtitle span { opacity: 0.2; animation: letterBlink 2s infinite; }
        @keyframes letterBlink { 0%, 100% { opacity: 0.2; text-shadow: none; } 50% { opacity: 1; text-shadow: 0 0 12px rgba(255, 255, 255, 0.8); } }
        .splash-subtitle { display: flex; font-size: 0.8rem; font-weight: 500; color: var(--primary-white); margin-top: 0.75rem; letter-spacing: -0.02em; }
        .home-screen { min-height: 100vh; padding: 2.5rem 1.5rem; display: flex; flex-direction: column; align-items: center; }
        .header { width: 100%; max-width: 500px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; }
        .logo-image { height: 32px; vertical-align: middle; }
        .lang-selector { padding: 0.6rem 1rem; background: var(--light-gray); border: 1px solid var(--border-color); border-radius: 0; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease; box-shadow: none; appearance: none; -webkit-appearance: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke-width='3' stroke='%23111111'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='m19.5 8.25-7.5 7.5-7.5-7.5' /%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 0.7rem center; background-size: 1em; padding-right: 2.5rem; }
        .main-content { flex: 1; display: flex; flex-direction: column; justify-content: flex-start; padding-top: 1rem; align-items: center; text-align: center; gap: 2.5rem; width: 100%; max-width: 500px; }
        .welcome-text h1 { font-size: clamp(2.2rem, 8vw, 3.2rem); font-weight: 800; line-height: 1.2; letter-spacing: -0.04em; margin-bottom: 0.8rem; }
        .welcome-text p { font-size: 1.15rem; color: var(--accent-gray); font-weight: 500; }
        .typing-cursor { display: inline-block; width: 2px; height: 1em; background-color: var(--primary-black); animation: typingBlink 0.7s infinite; margin-left: 3px; vertical-align: text-bottom; }
        @keyframes typingBlink { 0%, 100% { opacity: 1; } 50% { opacity: 0; } }
        .search-options { width: 100%; display: flex; flex-direction: column; gap: 1rem; }
        .search-option { background: var(--primary-white); border: 2px solid var(--primary-black); border-radius: 0; padding: 1.5rem; display: flex; align-items: center; gap: 1rem; cursor: pointer; transition: all 0.2s ease-out; box-shadow: 4px 4px 0px var(--primary-black); }
        .search-option:hover { transform: translate(-2px, -2px); box-shadow: 6px 6px 0px var(--primary-black); background-color: var(--light-gray); }
        .option-icon { width: 3.5rem; height: 3.5rem; color: var(--primary-black); background: var(--light-gray); border-radius: 0; display: flex; align-items: center; justify-content: center; flex-shrink: 0; border: 1px solid var(--border-color); padding: 0.5rem; }
        .option-icon svg { width: 100%; height: 100%; object-fit: contain; }
        .option-info { flex: 1; text-align: left; }
        .option-title { font-size: 1.1rem; font-weight: 700; margin-bottom: 0.25rem; letter-spacing: -0.01em; }
        .option-desc { font-size: 0.9rem; color: var(--accent-gray); line-height: 1.4; font-weight: 400; }
        .page-slide-right { position: fixed; inset: 0; background: var(--primary-white); z-index: 1000; transition: transform 0.3s cubic-bezier(0.7, 0, 0.3, 1); box-shadow: none; overflow-y: auto; transform: translateX(100%); }
        .page-slide-right.active { transform: translateX(0); }
        .page-header { background: var(--primary-white); padding: 1rem 1.5rem; display: flex; align-items: center; gap: 0.8rem; border-bottom: 2px solid var(--primary-black); z-index: 100; position: sticky; top: 0; }
        .back-btn { width: 44px; height: 44px; border-radius: 0; background: var(--primary-black); color: var(--primary-white); border: none; font-size: 1.5rem; font-weight: 800; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease-out; box-shadow: none; }
        .header-logo { flex: 1; text-align: center; margin-right: 44px; cursor: pointer; transition: opacity 0.2s; }
        .header-logo:hover { opacity: 0.7; }
        .search-bar-container { flex: 1; display: flex; gap: 0.5rem; }
        .search-input { flex: 1; padding: 0.8rem 1.2rem; border: 2px solid var(--primary-black); border-radius: 0; background: var(--light-gray); font-size: 1rem; outline: none; transition: all 0.2s ease-out; box-shadow: inset 2px 2px 0px rgba(0, 0, 0, 0.1); }
        .search-submit-btn { width: 44px; height: 44px; border: 2px solid var(--primary-black); background: var(--primary-black); color: var(--primary-white); cursor: pointer; flex-shrink: 0; display: flex; align-items: center; justify-content: center; }
        .results-container { padding: 0.5rem 1.5rem; }
        .result-card { background: transparent; border-bottom: 1px solid var(--border-color); padding: 1rem 0.5rem; cursor: pointer; transition: background-color 0.15s ease-out; }
        .result-card:hover { background-color: var(--light-gray); }
        .result-name { font-size: 1.05rem; font-weight: 600; margin-bottom: 0.2rem; }
        .result-desc { font-size: 0.85rem; color: var(--accent-gray); font-weight: 400; }
        .detail-text-content { padding: 2rem 1.5rem; background: var(--primary-white); text-align: left;}
        .detail-title { font-size: 2.2rem; font-weight: 800; letter-spacing: -0.03em; margin-bottom: 0.5rem; }
        .detail-subtitle { font-size: 1rem; color: var(--accent-gray); margin-bottom: 0; font-weight: 500; }
        .info-grid { display: flex; flex-direction: column; gap: 0; margin: 1.5rem 0; border-top: 1px solid var(--border-color); }
        .info-item { background: transparent; padding: 0.9rem 0.25rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .info-label { font-size: 0.9rem; color: var(--accent-gray); font-weight: 500; flex-shrink: 0; padding-right: 1rem; }
        .info-value { font-size: 0.95rem; font-weight: 600; text-align: right; color: var(--primary-black); word-break: break-all; width: 40%; }
        .scanner-modal { position: fixed; inset: 0; background: rgba(0, 0, 0, 0.85); z-index: 3000; display: none; align-items: center; justify-content: center; padding: 1rem; }
        .scanner-modal.active { display: flex; }
        .barcode-modal-content { background: var(--primary-white); border-radius: 0; width: 100%; max-width: 80vw; margin: 0 auto; overflow: hidden; display: flex; flex-direction: column; border: 2px solid var(--primary-black); box-shadow: 6px 6px 0px rgba(0, 0, 0, 0.2); }
        .barcode-header { background: var(--primary-black); padding: 1rem 1.5rem; display: flex; align-items: center; justify-content: space-between; color: var(--primary-white); }
        .close-scan-btn { width: 36px; height: 36px; border-radius: 0; background: rgba(255, 255, 255, 0.2); border: none; color: var(--primary-white); font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .scan-title { font-size: 1.1rem; font-weight: 700; flex: 1; text-align: center; margin-right: 2.25rem; }
        .scanner-container { position: relative; background: #000; height: 400px; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        #scanner-viewport, #scanner-viewport video, #scanner-viewport canvas { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; }
        #ai-scanner-viewport { width: 100%; height: 100%; position: relative; }
        #ai-scanner-video { width: 100%; height: 100%; object-fit: cover; }
        #ai-overlay-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        .scan-overlay { position: absolute; inset: 0; pointer-events: none; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .scan-guide { width: 70%; max-width: 300px; height: 120px; position: relative; border: 2px solid #00FF00; }
        .scan-guide-ai { width: 85%; max-width: 400px; height: 200px; position: relative; border: none; }
        .scan-line { position: absolute; top: 0; left: 0; right: 0; height: 2px; background: #00FF00; animation: scan 2s cubic-bezier(0.5, 0, 0.5, 1) infinite; box-shadow: 0 0 8px #00FF00; }
        @keyframes scan { 0% { transform: translateY(0); } 100% { transform: translateY(118px); } }
        .scan-corner { position: absolute; width: 40px; height: 40px; border: 3px solid #00FF00; animation: cornerPulse 2s ease-in-out infinite; }
        .scan-corner.top-left { top: 0; left: 0; border-right: none; border-bottom: none; }
        .scan-corner.top-right { top: 0; right: 0; border-left: none; border-bottom: none; }
        .scan-corner.bottom-left { bottom: 0; left: 0; border-right: none; border-top: none; }
        .scan-corner.bottom-right { bottom: 0; right: 0; border-left: none; border-top: none; }
        @keyframes cornerPulse { 0%, 100% { opacity: 0.6; box-shadow: 0 0 10px rgba(0, 255, 0, 0.3); } 50% { opacity: 1; box-shadow: 0 0 20px rgba(0, 255, 0, 0.8); } }
        .scan-lines { position: absolute; inset: 0; overflow: hidden; }
        .scan-line-horizontal { position: absolute; left: 0; right: 0; height: 2px; background: linear-gradient(90deg, transparent 0%, #00FF00 20%, #00FF00 80%, transparent 100%); box-shadow: 0 0 10px #00FF00; animation: scanHorizontal 3s ease-in-out infinite; }
        .scan-line-vertical { position: absolute; top: 0; bottom: 0; width: 2px; background: linear-gradient(180deg, transparent 0%, #00FF00 20%, #00FF00 80%, transparent 100%); box-shadow: 0 0 10px #00FF00; animation: scanVertical 2.5s ease-in-out infinite; animation-delay: 0.5s; }
        @keyframes scanHorizontal { 0%, 100% { top: 0; opacity: 0; } 10% { opacity: 1; } 90% { opacity: 1; } 100% { top: 100%; opacity: 0; } }
        @keyframes scanVertical { 0%, 100% { left: 0; opacity: 0; } 10% { opacity: 1; } 90% { opacity: 1; } 100% { left: 100%; opacity: 0; } }
        .scan-particles { position: absolute; inset: 0; pointer-events: none; }
        .particle { position: absolute; width: 4px; height: 4px; background: #00FF00; border-radius: 50%; opacity: 0; animation: particleFloat 3s ease-in-out infinite; box-shadow: 0 0 6px #00FF00; }
        .particle:nth-child(1) { left: 10%; animation-delay: 0s; }
        .particle:nth-child(2) { left: 30%; animation-delay: 0.5s; }
        .particle:nth-child(3) { left: 50%; animation-delay: 1s; }
        .particle:nth-child(4) { left: 70%; animation-delay: 1.5s; }
        .particle:nth-child(5) { left: 90%; animation-delay: 2s; }
        @keyframes particleFloat { 0% { top: 100%; opacity: 0; } 20% { opacity: 1; } 80% { opacity: 1; } 100% { top: 0; opacity: 0; } }
        .scan-grid { position: absolute; inset: 0; background-image: linear-gradient(rgba(0, 255, 0, 0.1) 1px, transparent 1px), linear-gradient(90deg, rgba(0, 255, 0, 0.1) 1px, transparent 1px); background-size: 20px 20px; animation: gridPulse 2s ease-in-out infinite; }
        @keyframes gridPulse { 0%, 100% { opacity: 0.3; } 50% { opacity: 0.6; } }
        .ai-detection-info { position: absolute; bottom: 1rem; left: 50%; transform: translateX(-50%); background: rgba(0, 0, 0, 0.8); color: white; padding: 0.5rem 1rem; border-radius: 4px; font-size: 0.9rem; font-weight: 600; }
        .manual-input { padding: 1.5rem; background: var(--light-gray); border-top: 1px solid var(--border-color); }
        .barcode-input { width: 100%; padding: 0.8rem 1rem; border: 2px solid var(--primary-black); border-radius: 0; font-size: 1rem; text-align: center; margin-bottom: 0.8rem; outline: none; background-color: var(--primary-white); transition: all 0.2s ease-out; box-shadow: inset 2px 2px 0px rgba(0, 0, 0, 0.1); }
        .search-barcode-btn { width: 100%; padding: 0.9rem; background: var(--primary-black); color: var(--primary-white); border: 2px solid var(--primary-black); border-radius: 0; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: all 0.2s ease-out; box-shadow: 3px 3px 0px rgba(0, 0, 0, 0.2); }
        .loading { text-align: center; padding: 3rem; color: var(--accent-gray); font-weight: 500; font-size: 1rem; }
        .spinner { width: 36px; height: 36px; border: 3px solid var(--border-color); border-top-color: var(--primary-black); border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 1rem; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .toast { position: fixed; bottom: 2.5rem; left: 50%; transform: translateX(-50%) translateY(100px); background: var(--primary-black); color: var(--primary-white); padding: 0.8rem 1.2rem; border-radius: 0; font-size: 0.9rem; z-index: 5000; opacity: 0; transition: all 0.3s ease-out; box-shadow: 4px 4px 0px rgba(0, 0, 0, 0.2); }
        .toast.show { transform: translateX(-50%) translateY(0); opacity: 1; }
        .no-results { text-align: center; padding: 4rem 1.5rem; color: var(--accent-gray); font-weight: 500; font-size: 1rem; }
        .recent-searches-title { font-size: 0.9rem; font-weight: 600; color: var(--accent-gray); padding: 1rem 1.5rem 0.5rem; }
        .recent-searches-list { display: flex; flex-wrap: wrap; gap: 0.5rem; padding: 0 1.5rem 1rem; border-bottom: 1px solid var(--border-color); margin-bottom: 1rem; }
        .recent-search-item { display: flex; align-items: center; gap: 0.5rem; background: var(--light-gray); padding: 0.4rem 0.8rem; border-radius: 1rem; font-size: 0.9rem; cursor: pointer; transition: background-color 0.2s ease; }
        .recent-search-item:hover { background-color: var(--hover-color); }
        .delete-search-btn { background: none; border: none; font-size: 1.2rem; color: var(--accent-gray); cursor: pointer; padding: 0; line-height: 1; }
        .delete-search-btn:hover { color: var(--primary-black); }
        .credit-footer { display: flex; align-items: center; justify-content: center; gap: 0.5rem; }
        .credit-logo { height: 2rem; width: auto; }
        .credit-text { font-size: 1rem; font-weight: bolder; color: #000; }
        @media (max-width: 600px) { input[type="text"], input[type="number"] { font-size: 16px; } }
    </style>
</head>

<body>
    <div class="splash-screen" id="splash">
        <div class="splash-logo-container">
            <div class="splash-title" id="splashTitle"></div>
        </div>
    </div>
    
    <main class="home-screen" id="home"> 
        <header class="header"> 
            <div class="logo"> 
                <img src="logo.jpeg" alt="HANNUN Logo" class="logo-image">
            </div> 
            <select id="langSelector" class="lang-selector" onchange="changeLanguage()"></select>
        </header> 
        
        <div class="main-content"> 
            <div class="welcome-text"> 
                <h1 id="appTitle">í•œêµ­ ì œí’ˆì„<br>ì‰½ê²Œ ì°¾ì•„ë³´ì„¸ìš”</h1> 
                <p id="appSubtitle">ê²€ìƒ‰ ë°©ë²•ì„ ì„ íƒí•˜ì„¸ìš”</p> 
            </div> 
            
            <div class="search-options"> 
                <div class="search-option" onclick="openBarcodeScanner()"> 
                    <div class="option-icon"> 
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"> 
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 4.5A.75.75 0 0 1 4.5 3.75h15a.75.75 0 0 1 .75.75v15a.75.75 0 0 1-.75.75h-15a.75.75 0 0 1-.75-.75v-15ZM8.25 9v6m3-6v6m3-6v6m3-6v6" /> 
                        </svg> 
                    </div> 
                    <div class="option-info"> 
                        <h3 class="option-title" id="scanBarcode">ë°”ì½”ë“œ ìŠ¤ìº”</h3> 
                        <p class="option-desc" id="scanBarcodeDesc">ë°”ì½”ë“œë¡œ ì •í™•í•˜ê²Œ ì œí’ˆ ì°¾ê¸°</p> 
                    </div> 
                </div>
                
                <div class="search-option" onclick="openImageSearch()">
                    <div class="option-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.456 2.456L21.75 6l-1.035.259a3.375 3.375 0 00-2.456 2.456zM16.898 20.573L16.5 21.75l-.398-1.177a3.375 3.375 0 00-2.455-2.455L12.75 18l1.177-.398a3.375 3.375 0 002.455-2.455L16.5 14.25l.398 1.177a3.375 3.375 0 002.455 2.455L20.25 18l-1.177.398a3.375 3.375 0 00-2.455 2.455z" />
                        </svg>
                    </div>
                    <div class="option-info">
                        <h3 class="option-title" id="searchByImage">AI ì‹¤ì‹œê°„ ê²€ìƒ‰</h3>
                        <p class="option-desc" id="searchByImageDesc">ì¹´ë©”ë¼ë¡œ ì œí’ˆì„ ë¹„ì¶”ë©´ ìë™ ì¸ì‹</p>
                    </div>
                </div>

                <div class="search-option" onclick="showPage('searchResults')"> 
                    <div class="option-icon"> 
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"> 
                            <path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" /> 
                        </svg> 
                    </div>
                    <div class="option-info"> 
                        <h3 class="option-title" id="searchByName">ìƒí’ˆëª… ê²€ìƒ‰</h3> 
                        <p class="option-desc" id="searchByNameDesc">ì´ë¦„ì´ë‚˜ ë¸Œëœë“œë¡œ ì œí’ˆ ì°¾ê¸°</p> 
                    </div> 
                </div> 
            </div> 
            <div class="credit-footer">
                <img src="ditlogo.png" alt="DIT Logo" class="credit-logo">
                <p class="credit-text">ì»´í“¨í„°ì†Œí”„íŠ¸ì›¨ì–´ê³¼</p>
            </div>
        </div> 
    </main>

    <div class="page-slide-right" id="searchResults"> 
        <div class="page-header"> 
            <button class="back-btn" onclick="goBack()">â†</button> 
            <div class="search-bar-container">
                <input type="text" class="search-input" id="searchInput" placeholder="ìƒí’ˆëª…ì„ ì…ë ¥í•˜ì„¸ìš”...">
                <button class="search-submit-btn" id="searchBtn">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke-width="3" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z" />
                    </svg>
                </button>
            </div>
        </div> 
        <div id="recentSearchesContainer"></div>
        <div class="results-container" id="resultsContainer"></div> 
    </div>

    <div class="page-slide-right" id="detail"> 
        <div class="page-header"> 
            <button class="back-btn" onclick="goBack()">â†</button> 
            <div class="header-logo" onclick="goToHome()">
                <img src="logo.jpeg" alt="HANNUN Logo" class="logo-image">
            </div> 
        </div> 
        <div id="detailPageContent"></div> 
    </div>

    <div class="scanner-modal" id="scannerModal"> 
        <div class="barcode-modal-content"> 
            <div class="barcode-header"> 
                <h3 class="scan-title" id="barcodeScanTitle">ë°”ì½”ë“œ ìŠ¤ìºë„ˆ</h3> 
                <button class="close-scan-btn" onclick="closeScanner()">Ã—</button> 
            </div> 
            <div class="scanner-container" id="scanner-container"> 
                <div id="scanner-viewport"></div> 
                <div class="scan-overlay"> 
                    <div class="scan-guide"> 
                        <div class="scan-line"></div> 
                    </div> 
                </div>
            </div>
            <div class="manual-input"> 
                <input type="number" class="barcode-input" id="manualBarcode" placeholder="ë°”ì½”ë“œ ë²ˆí˜¸ ì§ì ‘ ì…ë ¥"> 
                <button class="search-barcode-btn" id="searchBarcodeBtn" onclick="searchByManualBarcode()">ê²€ìƒ‰</button> 
            </div> 
        </div> 
    </div>

    <div class="scanner-modal" id="aiScannerModal">
        <div class="barcode-modal-content">
            <div class="barcode-header">
                <h3 class="scan-title" id="aiScanTitle">AI ì‹¤ì‹œê°„ ì¸ì‹</h3>
                <button class="close-scan-btn" onclick="closeAIScanner()">Ã—</button>
            </div>
            <div class="scanner-container" id="ai-scanner-container">
                <div id="ai-scanner-viewport">
                    <video id="ai-scanner-video" autoplay playsinline></video>
                    <canvas id="ai-overlay-canvas"></canvas>
                </div>
                <div class="ai-detection-info" id="aiDetectionInfo" style="display:none;"></div>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>


    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>
    <script>
        // --- API & ì„¤ì • ---
        const FOOD_API_KEY = 'c320de96f22d4183bd13';
        const TRANSLATE_API_KEY = 'AIzaSyAg0mabgEL-U3ntRxivf2rZvdf96xv6uro';
        const GEMINI_API_KEY = 'AIzaSyC3ICg1-2KW_U5QZHqnyL03a8tgox6cRfk';
        const GEMINI_URL = `https://generativelanguage.googleapis.com/v1/models/gemini-2.5-pro:generateContent?key=${GEMINI_API_KEY}`;
        const PROXY_URL = 'https://corsproxy.io/?';
        const FOOD_API_BASE = `https://openapi.foodsafetykorea.go.kr/api/${FOOD_API_KEY}/C005/json`;
        
        // --- ì „ì—­ ë³€ìˆ˜ ---
        let currentLang = 'ko';
        let searchCache = null; 
        let pageHistory = ['home'];
        let isTranslatingCache = false;
        let productModel = null;
        let recentSearches = [];
        const MAX_RECENT_SEARCHES = 5;
        
        // --- ìºì‹œ ê°ì²´ ---
        const cache = {
            details: {},
            geminiLists: {}
        };
        
        const AI_MODEL_INPUT_SIZE = 640;

        // --- AI ëª¨ë¸ í´ë˜ìŠ¤ ì´ë¦„ ---
        const CLASS_NAMES = [
            'chocopie',     // 2
            'coffee',       // 3
            'getorade',   // 4
            'milk',
            'ohyes',
            'tonk',
            'almond'       // 1  
        ];
        
        const CLASS_BARCODES = {
            'chocopie': '8801117539818',
            'tonk': '8801117269203',
            'ohyes': '8801019308598',
            'coffee': '8801121652022',
            'milk': '8801121112380',
            'getorade': '8801056052256',
            'almond': '' // ë¹„ì›Œë‘  - ë‚˜ì¤‘ì— ìˆ˜ì • ê°€ëŠ¥
        };
        
        // --- ë‹¤êµ­ì–´ í…ìŠ¤íŠ¸ ë° ì§€ì› ì–¸ì–´ ---
        const supportedLanguages = [
            { code: 'ko', name: 'ğŸ‡°ğŸ‡· í•œêµ­ì–´' }, { code: 'en', name: 'ğŸ‡ºğŸ‡¸ English' }, { code: 'ja', name: 'ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª' },
            { code: 'zh-CN', name: 'ğŸ‡¨ğŸ‡³ ä¸­æ–‡ (ç®€ä½“)' }, { code: 'es', name: 'ğŸ‡ªğŸ‡¸ EspaÃ±ol' }, { code: 'fr', name: 'ğŸ‡«ğŸ‡· FranÃ§ais' },
            { code: 'de', name: 'ğŸ‡©ğŸ‡ª Deutsch' }, { code: 'vi', name: 'ğŸ‡»ğŸ‡³ Tiáº¿ng Viá»‡t' }, { code: 'th', name: 'ğŸ‡¹ğŸ‡­ à¸ à¸²à¸©à¸²à¹„à¸—à¸¢' },
            { code: 'ru', name: 'ğŸ‡·ğŸ‡º Ğ ÑƒÑÑĞºĞ¸Ğ¹' }
        ];

        const translations = {
            ko: { appTitle: 'í•œêµ­ ì œí’ˆì„<br>ì‰½ê²Œ ì°¾ì•„ë³´ì„¸ìš”', appSubtitle: 'ê²€ìƒ‰ ë°©ë²•ì„ ì„ íƒí•˜ì„¸ìš”', searchByName: 'ìƒí’ˆëª… ê²€ìƒ‰', searchByNameDesc: 'ì´ë¦„ì´ë‚˜ ë¸Œëœë“œë¡œ ì œí’ˆ ì°¾ê¸°', scanBarcode: 'ë°”ì½”ë“œ ìŠ¤ìº”', scanBarcodeDesc: 'ë°”ì½”ë“œë¡œ ì •í™•í•˜ê²Œ ì œí’ˆ ì°¾ê¸°', searchByImage: 'AI ì‹¤ì‹œê°„ ì¸ì‹', searchByImageDesc: 'ì¹´ë©”ë¼ë¡œ ì œí’ˆì„ ë¹„ì¶”ë©´ ìë™ ì¸ì‹', searchPlaceholder: 'ìƒí’ˆëª…ì„ ì…ë ¥í•˜ì„¸ìš”...', productDetail: 'ìƒí’ˆ ìƒì„¸ ì •ë³´', manufacturer: 'ì œì¡°ì‚¬', barcode: 'ë°”ì½”ë“œ', searching: 'ê²€ìƒ‰ ì¤‘...', noResults: 'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤', loadingInfo: 'ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...', errorLoading: 'ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ ë°œìƒ', barcodeTitle: 'ë°”ì½”ë“œ ìŠ¤ìºë„ˆ', aiScanTitle: 'AI ì‹¤ì‹œê°„ ì¸ì‹', search: 'ê²€ìƒ‰', product_not_found: 'ìƒí’ˆì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', camera_error: 'ì¹´ë©”ë¼ë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', invalid_barcode: 'ìœ íš¨í•œ ë°”ì½”ë“œ ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', preparing_dictionary: 'ì‚¬ì „ ë°ì´í„° ì¤€ë¹„ ì¤‘...', gemini_searching: 'ì—°ê´€ ìƒí’ˆ ê²€ìƒ‰ ì¤‘...', translating: 'ë²ˆì—­ ì¤‘...', model_loading: 'AI ëª¨ë¸ ë¡œë”© ì¤‘...', recent_searches: 'ìµœê·¼ ê²€ìƒ‰ì–´', ai_demo_toast: 'AI ì¸ì‹ì€ ë°ëª¨ ëª¨ë¸ë¡œ ì‘ë™í•©ë‹ˆë‹¤.' },
            en: { appTitle: 'Find Korean<br>Products Easily', appSubtitle: 'Choose your search method', searchByName: 'Search by Name', searchByNameDesc: 'Find products using their name', scanBarcode: 'Scan Barcode', scanBarcodeDesc: 'Find products with their barcode', searchByImage: 'Live AI Recognition', searchByImageDesc: 'Point your camera to recognize products', searchPlaceholder: 'Enter product name...', productDetail: 'Product Details', manufacturer: 'Manufacturer', barcode: 'Barcode', searching: 'Searching...', noResults: 'No search results found', loadingInfo: 'Loading information...', errorLoading: 'Error loading details', barcodeTitle: 'Barcode Scanner', aiScanTitle: 'Live AI Recognition', search: 'Search', product_not_found: 'Product not found.', camera_error: 'Could not access camera.', invalid_barcode: 'Please enter a valid barcode.', preparing_dictionary: 'Preparing dictionary...', gemini_searching: 'Searching related items...', translating: 'Translating...', model_loading: 'Loading AI model...', recent_searches: 'Recent Searches', ai_demo_toast: 'AI Recognition is running on a demo model.' },
            ja: { appTitle: 'éŸ“å›½è£½å“ã‚’<br>ç°¡å˜ã«è¦‹ã¤ã‘ã‚ˆã†', appSubtitle: 'æ¤œç´¢æ–¹æ³•ã‚’é¸ã‚“ã§ãã ã•ã„', searchByName: 'å•†å“åã§æ¤œç´¢', searchByNameDesc: 'å•†å“åã§è£½å“ã‚’æ¤œç´¢', scanBarcode: 'ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’ã‚¹ã‚­ãƒ£ãƒ³', scanBarcodeDesc: 'ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã§è£½å“ã‚’æ¤œç´¢', searchByImage: 'AIãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ èªè­˜', searchByImageDesc: 'ã‚«ãƒ¡ãƒ©ã§è£½å“ã‚’è‡ªå‹•èªè­˜', searchPlaceholder: 'å•†å“åã‚’å…¥åŠ›...', productDetail: 'å•†å“è©³ç´°', manufacturer: 'è£½é€ ç¤¾', barcode: 'ãƒãƒ¼ã‚³ãƒ¼ãƒ‰', searching: 'æ¤œç´¢ä¸­...', noResults: 'æ¤œç´¢çµæœãŒã‚ã‚Šã¾ã›ã‚“', loadingInfo: 'æƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­...', errorLoading: 'ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ', barcodeTitle: 'ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒŠãƒ¼', aiScanTitle: 'AIãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ èªè­˜', search: 'æ¤œç´¢', product_not_found: 'è£½å“ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', camera_error: 'ã‚«ãƒ¡ãƒ©ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“', invalid_barcode: 'æœ‰åŠ¹ãªãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', preparing_dictionary: 'è¾æ›¸ã‚’æº–å‚™ã—ã¦ã„ã¾ã™...', gemini_searching: 'é–¢é€£å•†å“ã‚’æ¤œç´¢ä¸­...', translating: 'ç¿»è¨³ä¸­...', model_loading: 'AIãƒ¢ãƒ‡ãƒ«èª­ã¿è¾¼ã¿ä¸­...', recent_searches: 'æœ€è¿‘ã®æ¤œç´¢', ai_demo_toast: 'AIèªè­˜ã¯ãƒ‡ãƒ¢ãƒ¢ãƒ‡ãƒ«ã§å‹•ä½œã—ã¾ã™ã€‚' }
        };
        
        const getText = (key) => (translations[currentLang] && translations[currentLang][key]) || (translations['ko'] && translations['ko'][key]) || key;
        
        async function loadAIModel() {
            try {
                showToast(getText('model_loading'));
                const modelURL = 'https://rawcdn.githack.com/BeomE02/TeamSemicolon/d3190d98ac55aa2fefbdc1dccdb0d6839daf11e0/best.onnx';
                productModel = await ort.InferenceSession.create(modelURL);
                console.log('AI ëª¨ë¸ ë¡œë“œ ì™„ë£Œ');
            } catch (error) {
                console.error('AI ëª¨ë¸ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        function typeWriter(element, text, speed) {
            let i = 0;
            element.innerHTML = ''; // ì‹œì‘ ì „ ë‚´ìš©ì„ ë¹„ì›ë‹ˆë‹¤.
            const typing = () => {
                if (i < text.length) {
                    // '<br>' íƒœê·¸ë¥¼ ë§Œë‚˜ë©´ í•œ ë²ˆì— ì¶”ê°€í•˜ê³  ì¸ë±ìŠ¤ë¥¼ 4ì¹¸ ì´ë™
                    if (text.substring(i, i + 4) === '<br>') {
                        element.innerHTML = text.substring(0, i + 4) + '<span class="typing-cursor"></span>';
                        i += 4;
                    } else {
                        element.innerHTML = text.substring(0, i + 1) + '<span class="typing-cursor"></span>';
                        i++;
                    }
                    setTimeout(typing, speed);
                } else {
                    // ì• ë‹ˆë©”ì´ì…˜ì´ ëë‚˜ë©´ ì»¤ì„œ ì œê±°
                    element.innerHTML = text;
                }
            };
            typing();
        }
        
        document.addEventListener('DOMContentLoaded', () => {
            fetchAllProducts();
            loadAIModel();
        
            const langSelector = document.getElementById('langSelector');
            supportedLanguages.forEach(lang => {
                const option = document.createElement('option');
                option.value = lang.code;
                option.textContent = lang.name;
                if (lang.code === currentLang) option.selected = true;
                langSelector.appendChild(option);
            });
            updateUITexts();

            const splashTitle = document.getElementById('splashTitle');
            const text = "HANNUN";
            text.split('').forEach((letter, i) => {
                const span = document.createElement('span');
                span.textContent = letter;
                span.style.animationDelay = `${i * 0.1}s`;
                splashTitle.appendChild(span);
            });
            setTimeout(() => {
                document.getElementById('splash').classList.add('fade-out');
            }, 2500);

            setTimeout(() => {
                const appTitle = document.getElementById('appTitle');
                const initialTitle = getText('appTitle'); // í˜„ì¬ ì–¸ì–´ì— ë§ëŠ” í…ìŠ¤íŠ¸ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
                typeWriter(appTitle, initialTitle, 100);
            }, 3000);

            

            let searchTimeout;
            const searchInput = document.getElementById('searchInput');
            const searchBtn = document.getElementById('searchBtn');
            const performSearch = () => {
                clearTimeout(searchTimeout);
                const query = searchInput.value.trim();
                if (query.length > 0) searchProducts(query);
            };
            searchBtn.addEventListener('click', performSearch);
            searchInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') performSearch(); });
            searchInput.addEventListener('input', () => {
                clearTimeout(searchTimeout);
                const query = searchInput.value.trim();
                if (query.length > 0) searchTimeout = setTimeout(performSearch, 500);
            });
        });
        
        let aiScannerStream = null, aiScannerInterval = null, lastDetectedClass = null, detectionCooldown = false;
        
        function openImageSearch() {
            const modal = document.getElementById('aiScannerModal');
            if (!modal || !productModel) { showToast(getText('model_loading')); return; }
            showToast(getText('ai_demo_toast'));
            modal.classList.add('active');
            startAIScanner();
        }
        
        async function startAIScanner() {
            try {
                const video = document.getElementById('ai-scanner-video');
                aiScannerStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment', width: 640, height: 480 } });
                video.srcObject = aiScannerStream;
                aiScannerInterval = setInterval(async () => { if (!detectionCooldown) await captureAndRecognize(video); }, 500);
            } catch (error) {
                console.error('ì¹´ë©”ë¼ ì ‘ê·¼ ì‹¤íŒ¨:', error);
                showToast(getText('camera_error'));
                closeAIScanner();
            }
        }
        
        async function captureAndRecognize(video) {
            const canvas = document.createElement('canvas');
            canvas.width = AI_MODEL_INPUT_SIZE;
            canvas.height = AI_MODEL_INPUT_SIZE;
            const ctx = canvas.getContext('2d');
            const scale = Math.min(AI_MODEL_INPUT_SIZE / video.videoWidth, AI_MODEL_INPUT_SIZE / video.videoHeight);
            const x = (AI_MODEL_INPUT_SIZE - video.videoWidth * scale) / 2;
            const y = (AI_MODEL_INPUT_SIZE - video.videoHeight * scale) / 2;
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, AI_MODEL_INPUT_SIZE, AI_MODEL_INPUT_SIZE);
            ctx.drawImage(video, x, y, video.videoWidth * scale, video.videoHeight * scale);
            canvas.toBlob(async (blob) => {
                try {
                    const detections = await recognizeProductFromImage(blob);
                    
                    // ì˜¤ë²„ë ˆì´ ìº”ë²„ìŠ¤ ê°€ì ¸ì˜¤ê¸°
                    const overlayCanvas = document.getElementById('ai-overlay-canvas');
                    const overlayCtx = overlayCanvas.getContext('2d');
                    overlayCanvas.width = video.videoWidth;
                    overlayCanvas.height = video.videoHeight;
                    overlayCtx.clearRect(0, 0, overlayCanvas.width, overlayCanvas.height);
                    
                    if (detections && detections.length > 0) {
                        // ë°”ìš´ë”© ë°•ìŠ¤ ê·¸ë¦¬ê¸°
                        detections.forEach(det => {
                            const scaleX = video.videoWidth / AI_MODEL_INPUT_SIZE;
                            const scaleY = video.videoHeight / AI_MODEL_INPUT_SIZE;
                            
                            const boxX = (det.box.x - det.box.w / 2) * scaleX;
                            const boxY = (det.box.y - det.box.h / 2) * scaleY;
                            const boxW = det.box.w * scaleX;
                            const boxH = det.box.h * scaleY;
                            
                            // ë°•ìŠ¤ ê·¸ë¦¬ê¸°
                            overlayCtx.strokeStyle = '#00FF00';
                            overlayCtx.lineWidth = 3;
                            overlayCtx.strokeRect(boxX, boxY, boxW, boxH);
                            
                            // ë¼ë²¨ ë°°ê²½
                            overlayCtx.fillStyle = 'rgba(0, 255, 0, 0.8)';
                            overlayCtx.fillRect(boxX, boxY - 25, boxW, 25);
                            
                            // ë¼ë²¨ í…ìŠ¤íŠ¸
                            overlayCtx.fillStyle = '#000';
                            overlayCtx.font = 'bold 16px Arial';
                            overlayCtx.fillText(`${det.className} ${(det.confidence * 100).toFixed(0)}%`, boxX + 5, boxY - 7);
                        });
                        
                        const topDetection = detections[0];
                        if (topDetection.className !== lastDetectedClass) {
                            lastDetectedClass = topDetection.className;
                            detectionCooldown = true;
                            const infoEl = document.getElementById('aiDetectionInfo');
                            infoEl.textContent = `âœ… ì¸ì‹ë¨: ${topDetection.className}`;
                            infoEl.style.display = 'block';
                            infoEl.style.background = 'rgba(0, 200, 0, 0.9)';
                            if (navigator.vibrate) navigator.vibrate(100);
                            
                            // ë°”ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
                            const barcode = CLASS_BARCODES[topDetection.className];
                            
                            // ë°”ì½”ë“œê°€ ìˆìœ¼ë©´ ê²€ìƒ‰, ì—†ìœ¼ë©´ ì•Œë¦¼
                            setTimeout(() => {
                                closeAIScanner();
                                if (barcode) {
                                    findProductByBarcode(barcode);
                                } else {
                                    showToast(`${topDetection.className}ì˜ ë°”ì½”ë“œê°€ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.`);
                                }
                            }, 1000); // 1ì´ˆ í›„ ìë™ ê²€ìƒ‰
                        }
                    } else {
                        const infoEl = document.getElementById('aiDetectionInfo');
                        infoEl.textContent = 'ì¸ì‹í•  ìˆ˜ ìˆëŠ” ì‚¬ë¬¼ì„ ë¹„ì¶°ì£¼ì„¸ìš”';
                        infoEl.style.display = 'block';
                        infoEl.style.background = 'rgba(0, 0, 0, 0.8)';
                    }
                } catch (error) { console.error('ì¸ì‹ ì˜¤ë¥˜:', error); }
            }, 'image/jpeg', 0.8);
        }
        
        function closeAIScanner() {
            if (aiScannerInterval) { clearInterval(aiScannerInterval); aiScannerInterval = null; }
            if (aiScannerStream) { aiScannerStream.getTracks().forEach(track => track.stop()); aiScannerStream = null; }
            document.getElementById('aiScannerModal').classList.remove('active');
            document.getElementById('aiDetectionInfo').style.display = 'none';
            lastDetectedClass = null;
            detectionCooldown = false;
        }
        
        async function recognizeProductFromImage(imageFile) {
            if (!productModel) throw new Error('ëª¨ë¸ì´ ë¡œë“œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');
            
            const tensor = await preprocessImage(imageFile);
            const feeds = { images: tensor };
            const results = await productModel.run(feeds);
            
            // ëª¨ë¸ ì¶œë ¥ ê°€ì ¸ì˜¤ê¸°
            const output = results[Object.keys(results)[0]];
            const dims = output.dims; // [1, 7, 10, 8400]
            
            // ë°ì´í„°ë¥¼ ì˜¬ë°”ë¥¸ í˜•íƒœë¡œ ì¬êµ¬ì„±: [8400, 11]
            const numBoxes = 8400;
            const numClasses = 6;
            const boxData = new Float32Array(numBoxes * (4 + 1 + numClasses));
            
            // Shape [1, 7, 10, 8400] â†’ [8400, 11]ë¡œ ë³€í™˜
            // Sigmoid í•¨ìˆ˜ ì •ì˜
            const sigmoid = (x) => 1 / (1 + Math.exp(-x));
            
            // Shape [1, 7, 10, 8400] â†’ [8400, 11]ë¡œ ë³€í™˜ (Sigmoid ì ìš©)
            const rawData = output.data;
            for (let i = 0; i < numBoxes; i++) {
                // x, y, w, h (4ê°œ) - ì¢Œí‘œëŠ” ê·¸ëŒ€ë¡œ
                for (let j = 0; j < 4; j++) {
                    boxData[i * 11 + j] = rawData[j * numBoxes + i];
                }
                // confidence (1ê°œ) - Sigmoid ì ìš©
                boxData[i * 11 + 4] = sigmoid(rawData[4 * numBoxes + i]);
                // class scores (6ê°œ) - Sigmoid ì ìš©
                for (let j = 0; j < numClasses; j++) {
                    boxData[i * 11 + 5 + j] = sigmoid(rawData[(5 + j) * numBoxes + i]);
                }
            }
            
            // íƒì§€ ê²°ê³¼ íŒŒì‹±
            const detections = [];
            const confThreshold = 0.35; // ì‹ ë¢°ë„ ì„ê³„ê°’
            
            for (let i = 0; i < numBoxes; i++) {
                const offset = i * 11;
                const objectness = boxData[offset + 4];
                
                if (objectness < confThreshold) continue;
                
                // ê°€ì¥ ë†’ì€ í´ë˜ìŠ¤ í™•ë¥  ì°¾ê¸°
                let maxClassScore = 0;
                let maxClassIndex = 0;
                
                for (let j = 0; j < numClasses; j++) {
                    const classScore = boxData[offset + 5 + j];
                    if (classScore > maxClassScore) {
                        maxClassScore = classScore;
                        maxClassIndex = j;
                    }
                }
                
                const finalScore = objectness * maxClassScore;
                
                if (finalScore >= confThreshold) {
                    const x = boxData[offset + 0];
                    const y = boxData[offset + 1];
                    const w = boxData[offset + 2];
                    const h = boxData[offset + 3];
                    
                    detections.push({
                        class: maxClassIndex,
                        className: CLASS_NAMES[maxClassIndex],
                        confidence: finalScore,
                        box: { x, y, w, h }
                    });
                }
            }
            
            // NMS (Non-Maximum Suppression) ì ìš©
            const nmsDetections = applyNMS(detections, 0.45);
            
            console.log(`ğŸ¯ íƒì§€ ê²°ê³¼: ${nmsDetections.length}ê°œ ê°ì²´ ë°œê²¬`);
            nmsDetections.forEach(det => {
                console.log(`  - ${det.className}: ${(det.confidence * 100).toFixed(1)}%`);
            });
            
            return nmsDetections;
        }
        
        // NMS (Non-Maximum Suppression) í•¨ìˆ˜ ì¶”ê°€
        function applyNMS(detections, iouThreshold) {
            // ì‹ ë¢°ë„ ìˆœìœ¼ë¡œ ì •ë ¬
            detections.sort((a, b) => b.confidence - a.confidence);
            
            const keep = [];
            const suppressed = new Set();
            
            for (let i = 0; i < detections.length; i++) {
                if (suppressed.has(i)) continue;
                
                keep.push(detections[i]);
                
                for (let j = i + 1; j < detections.length; j++) {
                    if (suppressed.has(j)) continue;
                    
                    // ê°™ì€ í´ë˜ìŠ¤ë§Œ ë¹„êµ
                    if (detections[i].class !== detections[j].class) continue;
                    
                    const iou = calculateIoU(detections[i].box, detections[j].box);
                    if (iou > iouThreshold) {
                        suppressed.add(j);
                    }
                }
            }
            
            return keep;
        }
        
        // IoU (Intersection over Union) ê³„ì‚°
        function calculateIoU(box1, box2) {
            const x1 = Math.max(box1.x - box1.w / 2, box2.x - box2.w / 2);
            const y1 = Math.max(box1.y - box1.h / 2, box2.y - box2.h / 2);
            const x2 = Math.min(box1.x + box1.w / 2, box2.x + box2.w / 2);
            const y2 = Math.min(box1.y + box1.h / 2, box2.y + box2.h / 2);
            
            const intersection = Math.max(0, x2 - x1) * Math.max(0, y2 - y1);
            const area1 = box1.w * box1.h;
            const area2 = box2.w * box2.h;
            const union = area1 + area2 - intersection;
            
            return intersection / union;
        }
        
        async function preprocessImage(imageFile) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    const size = AI_MODEL_INPUT_SIZE;
                    canvas.width = size;
                    canvas.height = size;
                    const ctx = canvas.getContext('2d');
                    ctx.fillStyle = '#000';
                    ctx.fillRect(0, 0, size, size);
                    const scale = Math.min(size / img.width, size / img.height);
                    const x = (size - img.width * scale) / 2;
                    const y = (size - img.height * scale) / 2;
                    ctx.drawImage(img, x, y, img.width * scale, img.height * scale);
                    const imageData = ctx.getImageData(0, 0, size, size);
                    const float32Data = new Float32Array(3 * size * size);
                    for (let c = 0; c < 3; c++) {
                        for (let h = 0; h < size; h++) {
                            for (let w = 0; w < size; w++) {
                                const idx = (h * size + w) * 4 + c;
                                float32Data[c * size * size + h * size + w] = imageData.data[idx] / 255.0;
                            }
                        }
                    }
                    const tensor = new ort.Tensor('float32', float32Data, [1, 3, size, size]);
                    resolve(tensor);
                };
                img.src = URL.createObjectURL(imageFile);
            });
        }
        
        function showPage(pageId) {
            const newPage = document.getElementById(pageId);
            if (newPage && pageHistory[pageHistory.length - 1] !== pageId) {
                newPage.classList.add('active');
                pageHistory.push(pageId);
            }
            if (pageId === 'searchResults') {
                if (isTranslatingCache) document.getElementById('resultsContainer').innerHTML = `<div class="loading"><div class="spinner"></div>${getText('preparing_dictionary')}</div>`;
                displayRecentSearches();
                document.getElementById('searchInput').focus();
            }
        }
        
        function goBack() {
            if (pageHistory.length <= 1) return;
            const currentPageId = pageHistory.pop();
            const currentPage = document.getElementById(currentPageId);
            if (currentPage) currentPage.classList.remove('active');
            if (currentPageId === 'searchResults') {
                document.getElementById('searchInput').value = '';
                document.getElementById('resultsContainer').innerHTML = '';
            }
        }
        
        function goToHome() {
            document.querySelectorAll('.page-slide-right.active').forEach(page => page.classList.remove('active'));
            pageHistory = ['home'];
            document.getElementById('searchInput').value = '';
            document.getElementById('resultsContainer').innerHTML = '';
        }
        
        function updateUITexts() {
            // document.getElementById('appTitle').innerHTML = getText('appTitle'); // ì´ ì¤„ì´ ì‚­ì œëœ ìƒíƒœì…ë‹ˆë‹¤.
            document.getElementById('appSubtitle').textContent = getText('appSubtitle');
            document.getElementById('searchByName').textContent = getText('searchByName');
            document.getElementById('searchByNameDesc').textContent = getText('searchByNameDesc');
            document.getElementById('scanBarcode').textContent = getText('scanBarcode');
            document.getElementById('scanBarcodeDesc').textContent = getText('scanBarcodeDesc');
            document.getElementById('searchByImage').textContent = getText('searchByImage');
            document.getElementById('searchByImageDesc').textContent = getText('searchByImageDesc');
            document.getElementById('searchInput').placeholder = getText('searchPlaceholder');
            document.getElementById('barcodeScanTitle').textContent = getText('barcodeTitle');
            document.getElementById('aiScanTitle').textContent = getText('aiScanTitle');
            document.getElementById('searchBarcodeBtn').textContent = getText('search');
        }
        
        async function changeLanguage() {
            const selector = document.getElementById('langSelector');
            currentLang = selector.value;
            await translateUIRealtime(currentLang);
            updateUITexts();
        
            // ğŸ‘‡ ì´ ë¶€ë¶„ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤!
            const appTitle = document.getElementById('appTitle');
            const newTitleText = getText('appTitle');
            typeWriter(appTitle, newTitleText, 50); // ì–¸ì–´ ë³€ê²½ ì‹œì—ëŠ” ì¡°ê¸ˆ ë” ë¹ ë¥¸ ì†ë„ë¡œ ì‹¤í–‰
        
            await translateProductCache(currentLang);
        }

        async function translateUIRealtime(targetLang) {
            if (translations[targetLang] || targetLang === 'ko') return;
            showToast(getText('translating'));
            const koreanUI = translations['ko'];
            const keysToTranslate = Object.keys(koreanUI);
            const valuesToTranslate = Object.values(koreanUI).map(v => v.replace(/<br>/g, ' '));
            try {
                const translatedValues = await translate(valuesToTranslate, 'ko', targetLang, true);
                translations[targetLang] = {};
                keysToTranslate.forEach((key, index) => {
                    if (koreanUI[key].includes('<br>')) {
                        translations[targetLang][key] = translatedValues[index].replace(/\s/g, '<br>');
                    } else {
                        translations[targetLang][key] = translatedValues[index];
                    }
                });
            } catch (error) {
                console.error("UI ì‹¤ì‹œê°„ ë²ˆì—­ ì‹¤íŒ¨:", error);
                showToast("UI ë²ˆì—­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            }
        }
        
        async function fetchAllProducts() {
            if (searchCache) return;
            const url = `${FOOD_API_BASE}/1/1000`;
            try {
                const response = await fetch(PROXY_URL + url);
                if (!response.ok) throw new Error(`API ì‘ë‹µ ì‹¤íŒ¨: Status ${response.status}`);
                const data = await response.json();
                const apiResult = data.C005?.RESULT || data.RESULT;
                if (apiResult && apiResult.CODE !== 'INFO-000') throw new Error(`API ì˜¤ë¥˜: ${apiResult.MSG}`);
                searchCache = data.C005?.row || [];
            } catch (error) {
                console.error("ë°ì´í„° ë¡œë”© ì‹¤íŒ¨:", error);
                showToast(error.message);
                searchCache = [];
            }
        }
        
        async function translateProductCache(targetLang) {
            if (targetLang === 'ko' || !searchCache || isTranslatingCache || !['en', 'ja'].includes(targetLang)) return;
            const firstProduct = searchCache[0];
            if (firstProduct && firstProduct[`PRDLST_NM_${targetLang}`]) return;
            isTranslatingCache = true;
            showToast(getText('preparing_dictionary'));
            try {
                const productNames = [...new Set(searchCache.map(p => p.PRDLST_NM).filter(Boolean))];
                const companyNames = [...new Set(searchCache.map(p => p.BSSH_NM).filter(Boolean))];
                const CHUNK_SIZE = 100;
                const processInChunks = async (names) => {
                    const allTranslated = [];
                    for (let i = 0; i < names.length; i += CHUNK_SIZE) {
                        const chunk = names.slice(i, i + CHUNK_SIZE);
                        const translatedChunk = await translate(chunk, 'ko', targetLang, true);
                        allTranslated.push(...translatedChunk);
                        await new Promise(resolve => setTimeout(resolve, 100));
                    }
                    return allTranslated;
                };
                const [translatedProductNames, translatedCompanyNames] = await Promise.all([ processInChunks(productNames), processInChunks(companyNames) ]);
                const productNameMap = new Map(productNames.map((name, i) => [name, translatedProductNames[i]]));
                const companyNameMap = new Map(companyNames.map((name, i) => [name, translatedCompanyNames[i]]));
                searchCache.forEach(product => {
                    if (product.PRDLST_NM) product[`PRDLST_NM_${targetLang}`] = productNameMap.get(product.PRDLST_NM);
                    if (product.BSSH_NM) product[`BSSH_NM_${targetLang}`] = companyNameMap.get(product.BSSH_NM);
                });
            } catch (error) { console.error("ë²ˆì—­ ìºì‹œ ìƒì„± ì‹¤íŒ¨:", error); }
            finally { isTranslatingCache = false; }
        }
        
        async function searchProducts(query) {
            if (!searchCache) { showToast("ì œí’ˆ ë°ì´í„°ë¥¼ ë¡œë”© ì¤‘ì…ë‹ˆë‹¤."); return; }
            const container = document.getElementById('resultsContainer');
            container.innerHTML = `<div class="loading"><div class="spinner"></div>${getText('searching')}</div>`;
            let searchQuery = query;
            if (currentLang !== 'ko') {
                try {
                    showToast(getText('translating'));
                    searchQuery = await translate(query, currentLang, 'ko');
                } catch (e) {
                    showToast('ê²€ìƒ‰ì–´ ë²ˆì—­ ì‹¤íŒ¨');
                    container.innerHTML = `<div class="no-results">ê²€ìƒ‰ì–´ ë²ˆì—­ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</div>`;
                    return;
                }
            }
            const lowerCaseQuery = searchQuery.toLowerCase();
            const results = searchCache.filter(p => (p['PRDLST_NM']?.toLowerCase().includes(lowerCaseQuery)) || (p['BSSH_NM']?.toLowerCase().includes(lowerCaseQuery))).slice(0, 15);
            
            if (results.length === 0) {
                container.innerHTML = `<div class="loading"><div class="spinner"></div>${getText('gemini_searching')}</div>`;
                const originalKoreanList = await searchWithGeminiForList(searchQuery);
                if (originalKoreanList && originalKoreanList.length > 0) {
                    let displayList = originalKoreanList;
                    if (currentLang !== 'ko') {
                        try {
                            const [translatedNames, translatedCompanies] = await Promise.all([
                                translate(originalKoreanList.map(item => item.name), 'ko', currentLang, true),
                                translate(originalKoreanList.map(item => item.manufacturer), 'ko', currentLang, true)
                            ]);
                            displayList = originalKoreanList.map((item, index) => ({ name: translatedNames[index], manufacturer: translatedCompanies[index] }));
                        } catch (e) {
                            showToast('ê²°ê³¼ ë²ˆì—­ ì‹¤íŒ¨');
                        }
                    }
                    container.innerHTML = displayList.map((displayItem, index) => {
                        const originalProductName = originalKoreanList[index].name;
                        return `<div class="result-card" onclick="getDetailsAndShow('${originalProductName.replace(/"/g, '&quot;')}')"><h3 class="result-name">${displayItem.name}</h3><p class="result-desc">${displayItem.manufacturer}</p></div>`;
                    }).join('');
                } else {
                    container.innerHTML = `<div class="no-results">${getText('noResults')}</div>`;
                }
            } else {
                if(currentLang === 'ko') {
                    displayResults(results);
                } else {
                    showToast(getText('translating'));
                    try {
                        const [translatedNames, translatedCompanies] = await Promise.all([
                            translate(results.map(p => p.PRDLST_NM), 'ko', currentLang, true),
                            translate(results.map(p => p.BSSH_NM), 'ko', currentLang, true)
                        ]);
                        const translatedResults = results.map((p, i) => ({ ...p, PRDLST_NM_TRANS: translatedNames[i], BSSH_NM_TRANS: translatedCompanies[i] }));
                        displayResults(translatedResults, true);
                    } catch(e) {
                         showToast('ê²°ê³¼ ë²ˆì—­ ì‹¤íŒ¨');
                         displayResults(results);
                    }
                }
            }
        }

        async function searchWithGeminiForList(query) {
            const prompt = `ì´ì œ ê²€ìƒ‰ì—”ì§„ì²˜ëŸ¼ ì‘ë™í•´ë´. ì˜ˆë¥¼ë“¤ì–´ ë‚´ê°€ ì§„ë¼ë©´ì„ ê²€ìƒ‰í•˜ë©´ ë„ˆëŠ” ì§„ë¼ë©´ ë§¤ìš´ë§›, ì§„ë¼ë©´ ìˆœí•œë§›, ì§„ë¼ë©´ ì¤‘ê°„ë§› ë“±ë“± ì²˜ëŸ¼ ê²€ìƒ‰ì–´ ì—°ê´€ìˆœìœ¼ë¡œ ëŒ€ë‹µì„ í•˜ëŠ”ê±°ì•¼.ì´ì œ ë‚´ê°€ '${query}'(ìœ¼)ë¡œ ê²€ìƒ‰í•˜ë©´ ìƒí’ˆì˜ ì´ë¦„ê³¼ ì œì¡°ì‚¬ë¥¼ 'ì œí’ˆëª… | ì œì¡°ì‚¬' í˜•ì‹ìœ¼ë¡œ ì•Œë ¤ì¤˜. ë‹¤ë¥¸ ì„¤ëª…, ìˆ«ì, ê¸°í˜¸ ì—†ì´, í•œ ì¤„ì— í•˜ë‚˜ì”©ë§Œ ë‚˜ì—´í•´ì¤˜.`;
            try {
                const response = await fetch(GEMINI_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ "contents": [{ "parts": [{ "text": prompt }] }] })
                });
                if (!response.ok) throw new Error(`Gemini API Error: Status ${response.status}`);
                const data = await response.json();
                
                if (!data.candidates?.[0]?.content?.parts?.[0]?.text) {
                     throw new Error("Invalid response from Gemini.");
                }
                const rawText = data.candidates[0].content.parts[0].text;
                
                let translatedItems = await Promise.all(
                    rawText.split('\n').map(async line => {
                        const parts = line.split('|').map(part => part.trim());
                        if (parts.length === 2) {
                            let name = parts[0];
                            let manufacturer = parts[1];
                            if (currentLang !== 'ko') {
                                [name, manufacturer] = await Promise.all([
                                    translate(name, 'ko', currentLang),
                                    translate(manufacturer, 'ko', currentLang)
                                ]);
                            }
                            return { name, manufacturer };
                        }
                        return null;
                    })
                );
                return translatedItems.filter(item => item && item.name);
            } catch (error) {
                console.error("Gemini list search failed:", error);
                showToast("Failed to fetch related products.");
                return [];
            }
        }

        function displayResults(results, isTranslated = false) {
            const container = document.getElementById('resultsContainer');
            container.innerHTML = results.map(product => {
                const displayName = isTranslated ? product.PRDLST_NM_TRANS : product.PRDLST_NM;
                const displayCompany = isTranslated ? product.BSSH_NM_TRANS : product.BSSH_NM;
                return `<div class="result-card" onclick="getDetailsAndShow('${product.PRDLST_NM.replace(/"/g, '&quot;')}')"><h3 class="result-name">${displayName}</h3><p class="result-desc">${displayCompany}</p></div>`;
            }).join('');
        }
        
        async function getDetailsAndShow(productName, originalBarcode = null) {
            addRecentSearch(productName);
            showPage('detail');
            const content = document.getElementById('detailPageContent');
            content.innerHTML = `<div class="loading"><div class="spinner"></div>${getText('loadingInfo')}</div>`;
            const cleanName = productName.replace(/&quot;/g, '"');
            try {
                const cacheKey = `${cleanName}_ko`;
                let details = cache.details[cacheKey];
                
                // APIì—ì„œ ë°”ì½”ë“œ ì°¾ê¸°
                let apiBarcode = originalBarcode;
                if (!apiBarcode && searchCache) {
                    const apiProduct = searchCache.find(p => p.PRDLST_NM === cleanName);
                    if (apiProduct && apiProduct.BAR_CD) {
                        apiBarcode = apiProduct.BAR_CD;
                    }
                }
                
                if (!details) {
                    details = await getGeminiProductDetails(cleanName);
                    if (details) cache.details[cacheKey] = details;
                }
                
                if (details) {
                    // í˜¹ì‹œ ëª¨ë¥¼ Gemini ë°”ì½”ë“œ ì œê±°
                    delete details['ë°”ì½”ë“œ'];
                    delete details['ë°”ì½”ë“œ ë²ˆí˜¸'];
                    
                    // API ë°”ì½”ë“œë§Œ ì¶”ê°€
                    if(apiBarcode) {
                        details['ë°”ì½”ë“œ'] = apiBarcode;
                    }
                    
                    showProductDetail(details);
                } else { throw new Error(getText('errorLoading')); }
            } catch (error) { content.innerHTML = `<div class="no-results">${error.message}</div>`; }
        }

        async function getGeminiProductDetails(productName) {
            const prompt = `'${productName}' ìƒí’ˆ ì •ë³´ë¥¼ "í•­ëª©: ê°’" í˜•ì‹ìœ¼ë¡œë§Œ ë‚˜ì—´. ì œì¡°ì‚¬, ì œí’ˆ ì¹´í…Œê³ ë¦¬ëŠ” í•„ìˆ˜. ì‹í’ˆì´ë©´ ì¹¼ë¡œë¦¬/ì˜ì–‘ì„±ë¶„/ì„±ë¶„/ì•Œë ˆë¥´ê¸°/ë¹„ê±´, í™”ì¥í’ˆì´ë©´ ì œí’ˆìœ í˜•/ì£¼ìš”ì„±ë¶„/ë¹„ê±´ í¬í•¨. ì„¤ëª… ì—†ì´ ë°ì´í„°ë§Œ.`;
            try {
                const response = await fetch(GEMINI_URL, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ "contents": [{ "parts": [{ "text": prompt }] }] }) });
                if (!response.ok) throw new Error(`Gemini API ì˜¤ë¥˜: Status ${response.status}`);
                const data = await response.json();
                if (!data.candidates || !data.candidates[0].content.parts[0].text) throw new Error("Geminië¡œë¶€í„° ìœ íš¨í•œ ë‹µë³€ì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.");
                const rawText = data.candidates[0].content.parts[0].text;
                const product = { 'ìƒí’ˆëª…': productName };
                rawText.split('\n').forEach(line => {
                    const parts = line.split(':');
                    if (parts.length >= 2) {
                        const key = parts[0].trim().replace(/\*\*/g, '');
                        const value = parts.slice(1).join(':').trim().replace(/\*\*/g, '');
                        product[key] = value;
                    }
                });
                return product;
            } catch (error) {
                console.error("Gemini ìƒì„¸ ì •ë³´ ê²€ìƒ‰ ì‹¤íŒ¨:", error);
                showToast("ì œí’ˆ ìƒì„¸ ì •ë³´ë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                return null;
            }
        }
        
        async function showProductDetail(productData) {
            if (!productData) { goBack(); return; }
            showPage('detail');
            const content = document.getElementById('detailPageContent');
            content.innerHTML = `<div class="loading"><div class="spinner"></div>${getText('loadingInfo')}</div>`;
            let pName = productData['ìƒí’ˆëª…'] || '';
            let pCompany = productData['ì œì¡°ì‚¬'] || '-';
            let infoItems = { ...productData };
            delete infoItems['ìƒí’ˆëª…'];
            delete infoItems['ì œì¡°ì‚¬'];
            let title = pName, subtitle = pCompany, finalInfoItems = infoItems;
            if (currentLang !== 'ko') {
                showToast(getText('translating'));
                const keys = Object.keys(finalInfoItems);
                const values = Object.values(finalInfoItems);
                try {
                    const [translatedTitle, translatedSubtitle, translatedKeys, translatedValues] = await Promise.all([
                        translate(title, 'ko', currentLang), translate(subtitle, 'ko', currentLang),
                        translate(keys, 'ko', currentLang, true), translate(values, 'ko', currentLang, true)
                    ]);
                    title = translatedTitle;
                    subtitle = translatedSubtitle;
                    finalInfoItems = {};
                    translatedKeys.forEach((key, index) => { finalInfoItems[key] = translatedValues[index]; });
                } catch (e) { showToast('ìƒì„¸ ì •ë³´ ë²ˆì—­ ì‹¤íŒ¨'); }
            }
            const infoGridHtml = Object.entries(finalInfoItems).map(([key, value]) => {
                if (!value || String(value).toLowerCase() === 'ì •ë³´ ì—†ìŒ' || String(value).trim() === '') return '';
                return `<div class="info-item"><p class="info-label">${key}</p><p class="info-value">${value}</p></div>`;
            }).join('');
            content.innerHTML = `
                <div class="detail-text-content">
                    <h1 class="detail-title">${title}</h1>
                    <p class="detail-subtitle">${subtitle}</p>
                </div>
                <div class="detail-content" style="padding: 0 1.5rem;">
                    <div class="info-grid">${infoGridHtml}</div>
                </div>`;
        }
        
        async function translate(text, sourceLang, targetLang, isBatch = false) {
            if (!text || (Array.isArray(text) && text.length === 0)) return isBatch ? [] : "";
            if (sourceLang === targetLang || !TRANSLATE_API_KEY.startsWith('AIza')) return isBatch ? (Array.isArray(text) ? text.map(t => t) : [text]) : text;
            try {
                const response = await fetch(`https://translation.googleapis.com/language/translate/v2?key=${TRANSLATE_API_KEY}`, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ q: text, target: targetLang, source: sourceLang }) 
                });
                if (!response.ok) throw new Error(`ë²ˆì—­ API ì˜¤ë¥˜: ${response.status}`);
                const data = await response.json();
                return isBatch ? data.data.translations.map(t => t.translatedText) : data.data.translations[0].translatedText;
            } catch (error) {
                console.error("Translation Error:", error);
                throw error;
            }
        }
        
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }
        
        function addRecentSearch(query) {
            const index = recentSearches.indexOf(query);
            if (index > -1) recentSearches.splice(index, 1);
            recentSearches.unshift(query);
            if (recentSearches.length > MAX_RECENT_SEARCHES) recentSearches.pop();
        }

        function displayRecentSearches() {
            const container = document.getElementById('recentSearchesContainer');
            if (!container || recentSearches.length === 0) {
                if(container) container.innerHTML = '';
                return;
            }
            const listItems = recentSearches.map(term => `
                <div class="recent-search-item" onclick="searchFromRecent('${term.replace(/'/g, "\\'")}')">
                    <span>${term}</span>
                    <button class="delete-search-btn" onclick="removeRecentSearch(event, '${term.replace(/'/g, "\\'")}')">Ã—</button>
                </div>
            `).join('');
            container.innerHTML = `
                <h4 class="recent-searches-title">${getText('recent_searches')}</h4>
                <div class="recent-searches-list">${listItems}</div>`;
        }

        function searchFromRecent(term) {
            getDetailsAndShow(term);
        }

        function removeRecentSearch(event, term) {
            event.stopPropagation();
            recentSearches = recentSearches.filter(t => t !== term);
            displayRecentSearches();
        }
        
        let isScanning = false, scanLocked = false, detectionHistory = [];
        const STABLE_COUNT = 3;
        
        function openBarcodeScanner() {
            document.getElementById('scannerModal').classList.add('active');
            startScanning();
        }
        
        function closeScanner() {
            stopScanning();
            document.getElementById('scannerModal').classList.remove('active');
            document.getElementById('manualBarcode').value = '';
        }
        
        function normalizeEAN13(str) {
            const digits = (str || '').replace(/\D/g, '');
            return digits.length >= 13 ? digits.slice(0, 13) : digits.length >= 8 ? digits : null;
        }
        
        function onBarcodeDetected(result) {
            if (scanLocked) return;
            const raw = result.codeResult?.code;
            const normalized = normalizeEAN13(raw);
            if (!normalized) return;
            detectionHistory.push(normalized);
            const recent = detectionHistory.slice(-STABLE_COUNT);
            const stable = recent.length === STABLE_COUNT && recent.every(v => v === recent[0]);
            if (!stable) return;
            scanLocked = true;
            if (navigator.vibrate) navigator.vibrate(100);
            stopScanning();
            document.getElementById('manualBarcode').value = normalized;
            showToast(`ë°”ì½”ë“œ ì¸ì‹: ${normalized}`);
        }
        
        function startScanning() {
            if (isScanning) return;
            scanLocked = false;
            detectionHistory = [];
            Quagga.init({
                inputStream: { name: "Live", type: "LiveStream", target: document.querySelector('#scanner-viewport'), constraints: { width: { min: 640, ideal: 1920 }, height: { min: 480, ideal: 1080 }, facingMode: "environment" }, area: { top: "40%", right: "10%", left: "10%", bottom: "40%" } },
                locator: { patchSize: "small", halfSample: false },
                numOfWorkers: navigator.hardwareConcurrency || 4,
                decoder: { readers: ["ean_reader", "ean_8_reader", "code_128_reader"], multiple: false },
                locate: true
            }, (err) => {
                if (err) { console.error('Quagga ì´ˆê¸°í™” ì˜¤ë¥˜:', err); showToast(getText('camera_error')); return; }
                Quagga.start(); 
                isScanning = true;
                const video = document.querySelector('#scanner-viewport video');
                if (video) {
                    video.addEventListener('click', () => {
                        try {
                            const track = Quagga.CameraAccess.getActiveTrack();
                            if (track && typeof track.getCapabilities === 'function') {
                                const capabilities = track.getCapabilities();
                                if (capabilities.focusMode && capabilities.focusMode.includes('continuous')) {
                                    track.applyConstraints({ advanced: [{ focusMode: 'continuous' }] });
                                    showToast('ìë™ ì´ˆì  ì¬ì„¤ì •');
                                }
                            }
                        } catch (e) { console.warn('ì´ˆì  ì¬ì„¤ì • ê¸°ëŠ¥ì´ ì§€ì›ë˜ì§€ ì•ŠëŠ” ê¸°ê¸°ì…ë‹ˆë‹¤.', e); }
                    });
                }
                Quagga.onDetected(onBarcodeDetected);
            });
        }
        
        function stopScanning() { 
            if (isScanning && typeof Quagga !== 'undefined') { Quagga.offDetected(onBarcodeDetected); Quagga.stop(); isScanning = false; } 
        }
        
        function searchByManualBarcode() { 
            const barcode = document.getElementById('manualBarcode').value.trim(); 
            if (barcode.length < 8) { showToast(getText('invalid_barcode')); return; }
            const normalized = normalizeEAN13(barcode);
            if (!normalized) { showToast(getText('invalid_barcode')); return; }
            stopScanning(); 
            findProductByBarcode(normalized); 
        }
        
        async function findProductByBarcode(barcode) {
            closeScanner();
            showPage('detail');
            const content = document.getElementById('detailPageContent');
            content.innerHTML = `<div class="loading"><div class="spinner"></div>${getText('searching')}</div>`;
            try {
                const serviceId = 'C005';
                const url = `https://openapi.foodsafetykorea.go.kr/api/${FOOD_API_KEY}/${serviceId}/json/1/5/BAR_CD=${barcode}`;
                const response = await fetch(PROXY_URL + encodeURIComponent(url));
                if (!response.ok) throw new Error(`ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ${response.status}`);
                const data = await response.json();
                
                if (data[serviceId]?.RESULT?.CODE !== 'INFO-000' || !data[serviceId]?.row) {
                    const productName = await getProductNameFromBarcode(barcode);
                    if (productName) await getDetailsAndShow(productName);
                    else throw new Error(getText('product_not_found'));
                } else {
                    const product = data[serviceId].row[0] || data[serviceId].row;
                    if (product && product.PRDLST_NM) getDetailsAndShow(product.PRDLST_NM, barcode);
                    else throw new Error(getText('product_not_found'));
                }
            } catch (error) {
                console.error('ë°”ì½”ë“œ ê²€ìƒ‰ ì˜¤ë¥˜:', error);
                showToast(error.message || getText('product_not_found'));
                goBack();
            }
        }
        
        async function getProductNameFromBarcode(barcode) {
            const prompt = `í•œêµ­ ìƒí’ˆ ë°”ì½”ë“œ ë²ˆí˜¸ê°€ '${barcode}'ì¼ ë•Œ, ì´ ìƒí’ˆì˜ ê°€ì¥ ì •í™•í•œ ì „ì²´ ì œí’ˆ ì´ë¦„(ë¸Œëœë“œ í¬í•¨) í•˜ë‚˜ë§Œ ì•Œë ¤ì¤˜. ë‹¤ë¥¸ ì„¤ëª…ì€ ëª¨ë‘ ì œì™¸í•˜ê³  ì˜¤ì§ ì œí’ˆ ì´ë¦„ë§Œ ì‘ë‹µí•´ì¤˜.`;
            try {
                const response = await fetch(GEMINI_URL, { 
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json' }, 
                    body: JSON.stringify({ "contents": [{ "parts": [{ "text": prompt }] }] }) 
                });
                if (!response.ok) return null;
                const data = await response.json();
                if (!data.candidates || !data.candidates[0].content.parts[0].text) return null;
                return data.candidates[0].content.parts[0].text.trim();
            } catch (error) {
                console.error("ë°”ì½”ë“œ->ì´ë¦„ ë³€í™˜ ì‹¤íŒ¨:", error);
                return null;
            }
        }
    </script>
</body>
</html>
